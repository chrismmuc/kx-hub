name: Deploy KX-Hub

on:
  # Manual deployment trigger only
  workflow_dispatch:
    inputs:
      deploy_terraform:
        description: 'Deploy Terraform infrastructure'
        required: false
        type: boolean
        default: true
      deploy_mcp_server:
        description: 'Deploy MCP Server to Cloud Run'
        required: false
        type: boolean
        default: true
      terraform_action:
        description: 'Terraform action (plan or apply)'
        required: false
        type: choice
        options:
          - apply
          - plan
        default: apply

env:
  PROJECT_ID: kx-hub
  REGION: europe-west1
  TF_REGION: europe-west4  # Terraform resources region

jobs:
  # ============================================================================
  # Terraform Deployment Job
  # Deploys Cloud Functions, Firestore indexes, Cloud Workflows, etc.
  # Terraform itself handles change detection via state comparison
  # ============================================================================
  deploy-terraform:
    name: Deploy Terraform Infrastructure
    runs-on: ubuntu-latest
    if: inputs.deploy_terraform

    permissions:
      contents: read
      id-token: write

    defaults:
      run:
        working-directory: terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan \
            -var="project_id=${{ env.PROJECT_ID }}" \
            -var="region=${{ env.TF_REGION }}" \
            -out=tfplan \
            -no-color 2>&1 | tee plan_output.txt

          # Extract summary for GitHub
          echo "## Terraform Plan" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep -E "(Plan:|No changes|to add|to change|to destroy)" plan_output.txt >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Terraform Apply
        if: inputs.terraform_action == 'apply'
        run: |
          terraform apply -auto-approve tfplan

          echo "## Terraform Apply Complete" >> $GITHUB_STEP_SUMMARY
          echo "Infrastructure has been successfully deployed." >> $GITHUB_STEP_SUMMARY

      - name: Show Terraform Outputs
        if: success()
        run: |
          echo "## Terraform Outputs" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          terraform output -no-color >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No outputs defined" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # MCP Server Deployment Job
  # Builds and deploys the MCP Server to Cloud Run via Cloud Build
  # Cloud Build/Run handle change detection via image digest comparison
  # ============================================================================
  deploy-mcp-server:
    name: Deploy MCP Server to Cloud Run
    runs-on: ubuntu-latest
    if: inputs.deploy_mcp_server

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Trigger Cloud Build
        run: |
          gcloud builds submit \
            --config=cloudbuild.mcp-consolidated.yaml \
            --region=${{ env.REGION }}

      - name: Show deployment result
        run: |
          echo "## MCP Server Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Cloud Build has built and deployed the MCP Server to Cloud Run." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** kx-hub-mcp" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.REGION }}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Deployment Summary Job
  # Provides final summary of what was deployed
  # ============================================================================
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-terraform, deploy-mcp-server]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "# Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY

          # Terraform status
          if [ "${{ needs.deploy-terraform.result }}" == "success" ]; then
            echo "| Terraform Infrastructure | Deployed |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy-terraform.result }}" == "skipped" ]; then
            echo "| Terraform Infrastructure | Skipped (disabled) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Terraform Infrastructure | ${{ needs.deploy-terraform.result }} |" >> $GITHUB_STEP_SUMMARY
          fi

          # MCP Server status
          if [ "${{ needs.deploy-mcp-server.result }}" == "success" ]; then
            echo "| MCP Server (Cloud Run) | Deployed |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy-mcp-server.result }}" == "skipped" ]; then
            echo "| MCP Server (Cloud Run) | Skipped (disabled) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| MCP Server (Cloud Run) | ${{ needs.deploy-mcp-server.result }} |" >> $GITHUB_STEP_SUMMARY
          fi
