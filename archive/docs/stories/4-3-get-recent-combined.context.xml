<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>3</storyId>
    <title>Create `get_recent` Tool Combining Activity + Recent Items</title>
    <status>drafted</status>
    <generatedAt>2025-12-19</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/4-3-get-recent-combined.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>AI assistant using kx-hub MCP tools</asA>
    <iWant>single `get_recent` tool that returns both recent chunks and reading activity statistics</iWant>
    <soThat>I can get a complete view of recent reading in one API call instead of chaining `get_recently_added` and `get_reading_activity`</soThat>
    <tasks>
- Task 1: Implement `get_recent` function in tools.py (AC: 1-9)
  - 1.1 Define parameter schema (period, limit)
  - 1.2 Fetch recently added chunks from Firestore
  - 1.3 Fetch activity summary from Firestore
  - 1.4 Extract and format knowledge cards for each chunk
  - 1.5 Extract cluster info for each chunk
  - 1.6 Format all URLs using _format_urls helper
  - 1.7 Calculate cluster distribution from recent chunks
  - 1.8 Combine chunks and activity summary into unified response
- Task 2: Register `get_recent` tool in main.py (AC: 1)
  - 2.1 Add Tool definition with complete inputSchema
  - 2.2 Add handler in call_tool_handler switch
- Task 3: Unit tests (AC: 1-9)
  - 3.1 Test get_recent with default parameters
  - 3.2 Test recent chunks formatting with knowledge cards
  - 3.3 Test activity summary inclusion
  - 3.4 Test cluster distribution calculation
  - 3.5 Test different period values
  - 3.6 Test custom limit parameter
  - 3.7 Test URL fields inclusion
  - 3.8 Test empty results (no recent chunks)
  - 3.9 Test top sources and authors aggregation
- Task 4: Integration testing (AC: 1-10)
  - 4.1 Test via MCP protocol with Claude Desktop
  - 4.2 Verify response format matches expected schema
  - 4.3 Verify all embedded data (chunks, activity, distribution, URLs) present
    </tasks>
  </story>

  <acceptanceCriteria>
1. New `get_recent` tool registered in MCP server with optional period parameter
2. Recent chunks returned ordered by date with full chunk details (title, author, source, tags, content snippet)
3. Activity summary included showing total chunks added, days with activity, chunks per day
4. Top sources and authors for the period included in summary
5. Cluster distribution of recent items included showing which clusters new content belongs to
6. Knowledge cards embedded in chunk results by default
7. All URLs included (readwise_url, source_url, highlight_url) per Story 2.7
8. Optional period parameter supports time periods (default "last_7_days", supports "today", "yesterday", "last_3_days", "last_week", "last_30_days", "last_month")
9. Optional limit parameter controls max chunks returned (default 10)
10. Replaces 2 separate tools (`get_recently_added` and `get_reading_activity`) reducing tool count
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/epics.md" title="Epic 4: MCP Tool Consolidation" section="Story 4.3 Specification">
        Story 4.3 consolidates get_recently_added and get_reading_activity into unified get_recent tool. Returns recent chunks with activity summary and cluster distribution. Estimated effort: 1 day, complexity: Low.
      </doc>
      <doc path="docs/epics.md" title="Epic 4: MCP Tool Consolidation" section="Consolidated Tool Specification - get_recent">
        Defines complete parameter schema (period, limit) and expected response format including recent chunks array, activity summary object, and cluster distribution. Default behavior returns 10 chunks from last 7 days.
      </doc>
      <doc path="docs/architecture.md" title="MCP Server Architecture" section="Tool Registration Pattern">
        MCP tools registered in main.py using Tool() class with name, description, and inputSchema. Handler logic in call_tool_handler async function. Tool functions implemented in tools.py module.
      </doc>
      <doc path="docs/stories/4-1-search-kb-unified.md" title="Story 4.1: Create Unified search_kb Tool" section="Dev Notes">
        Establishes helper functions _format_urls(), _format_knowledge_card(), _format_cluster_info() in tools.py for reuse. Shows pattern for unified tool implementation with flexible parameters. TestSearchKBUnified provides testing pattern with 11 comprehensive tests.
      </doc>
      <doc path="docs/stories/4-2-get-chunk-enhanced.md" title="Story 4.2: Create get_chunk Tool" section="Dev Notes">
        Follows Story 4.1 pattern for tool consolidation. TestGetChunk class with 8 tests. All helper functions successfully reused. Tool registration positioned after previous consolidated tools for logical ordering.
      </doc>
    </docs>
    <code>
      <artifact path="src/mcp_server/tools.py" kind="module" symbol="_format_urls" lines="29-45" reason="Helper function to extract and format URL fields (readwise_url, source_url, highlight_url) from chunk data - REUSE for AC 7"/>
      <artifact path="src/mcp_server/tools.py" kind="module" symbol="_format_knowledge_card" lines="48-65" reason="Helper function to extract and format knowledge card from chunk.knowledge_card field - REUSE for AC 6"/>
      <artifact path="src/mcp_server/tools.py" kind="module" symbol="_format_cluster_info" lines="68-118" reason="Helper function to extract cluster membership info from chunk.cluster_id - REUSE for AC 5 and cluster distribution"/>
      <artifact path="src/mcp_server/tools.py" kind="module" symbol="get_recently_added" lines="1124-1185" reason="Existing function to fetch recent chunks - extract logic for Task 1.2, will be deprecated in Story 4.6"/>
      <artifact path="src/mcp_server/tools.py" kind="module" symbol="get_reading_activity" lines="1092-1122" reason="Existing function to fetch activity summary - extract logic for Task 1.3, will be deprecated in Story 4.6"/>
      <artifact path="src/mcp_server/firestore_client.py" kind="module" symbol="get_recently_added" reason="Function to fetch recently added chunks from Firestore - use for Task 1.2"/>
      <artifact path="src/mcp_server/firestore_client.py" kind="module" symbol="get_activity_summary" reason="Function to fetch reading activity stats from Firestore - use for Task 1.3"/>
      <artifact path="src/mcp_server/firestore_client.py" kind="module" symbol="get_cluster_by_id" reason="Function to fetch cluster metadata - use for cluster distribution calculation in Task 1.7"/>
      <artifact path="src/mcp_server/main.py" kind="server" symbol="list_tools_handler" lines="73-620" reason="Tool registration pattern - add get_recent Tool definition here for Task 2.1"/>
      <artifact path="src/mcp_server/main.py" kind="server" symbol="call_tool_handler" lines="649-870" reason="Tool handler switch statement - add get_recent case here for Task 2.2"/>
      <artifact path="tests/test_mcp_tools.py" kind="test" symbol="TestSearchKBUnified" lines="208-525" reason="Comprehensive test class pattern with 11 tests - follow for TestGetRecent class"/>
      <artifact path="tests/test_mcp_tools.py" kind="test" symbol="TestGetChunk" lines="527-852" reason="Test pattern for consolidated tool with 8 tests covering all ACs - adapt for TestGetRecent"/>
    </code>
    <dependencies>
      <python>
        <package name="google-cloud-firestore" version="^2.11.0" reason="Firestore client for chunk and activity retrieval"/>
        <package name="pytest" version="^9.0.1" reason="Testing framework for unit tests"/>
        <package name="unittest.mock" version="stdlib" reason="Mocking for Firestore calls in tests"/>
      </python>
    </dependencies>
  </artifacts>

  <constraints>
- Follow pattern from Story 4.1 and 4.2: single function in tools.py, registration in main.py, comprehensive test class
- REUSE existing helper functions (_format_urls, _format_knowledge_card, _format_cluster_info) - do NOT recreate
- Use existing firestore_client functions (get_recently_added, get_activity_summary, get_cluster_by_id) - do NOT reimplement
- Default parameters: period="last_7_days", limit=10
- Period to days mapping: today=1, yesterday=1, last_3_days=3, last_7_days=7, last_week=7, last_30_days=30, last_month=30
- Return ALL chunk fields: chunk_id, title, author, source, tags, snippet, chunk_info, added_date
- Return ALL activity fields: total_chunks_added, days_with_activity, chunks_by_day, top_sources, top_authors
- Calculate cluster distribution by grouping recent chunks by cluster_id and fetching cluster names
- Return all URLs (readwise_url, source_url, highlight_url) per Story 2.7 pattern
- Maintain backward compatibility: existing tools (get_recently_added, get_reading_activity) remain functional until Epic 4.6 deprecation
  </constraints>

  <interfaces>
    <interface name="get_recent MCP Tool" kind="MCP Tool Definition" path="src/mcp_server/main.py">
      <signature>
Tool(
  name="get_recent",
  description="Get recent reading activity and chunks (Story 4.3). Consolidates get_recently_added and get_reading_activity.",
  inputSchema={
    "type": "object",
    "properties": {
      "period": {
        "type": "string",
        "description": "Time period (default 'last_7_days')",
        "enum": ["today", "yesterday", "last_3_days", "last_week", "last_7_days", "last_month", "last_30_days"],
        "default": "last_7_days"
      },
      "limit": {
        "type": "integer",
        "description": "Maximum chunks to return (default 10)",
        "default": 10,
        "minimum": 1,
        "maximum": 50
      }
    }
  }
)
      </signature>
    </interface>
    <interface name="get_recent Function" kind="Python Function" path="src/mcp_server/tools.py">
      <signature>
def get_recent(period: str = "last_7_days", limit: int = 10) -> Dict[str, Any]:
    """
    Get recent reading activity and chunks.

    Returns:
    {
      "period": str,
      "recent_chunks": [
        {
          "chunk_id": str,
          "title": str,
          "author": str,
          "source": str,
          "tags": List[str],
          "snippet": str,
          "chunk_info": str,
          "added_date": str,
          "knowledge_card": {"summary": str, "takeaways": List[str]} | None,
          "cluster": {"cluster_id": str, "cluster_name": str, "description": str},
          "readwise_url": str | None,
          "source_url": str | None,
          "highlight_url": str | None
        }
      ],
      "activity_summary": {
        "total_chunks_added": int,
        "days_with_activity": int,
        "chunks_by_day": Dict[str, int],
        "top_sources": List[{"source": str, "count": int}],
        "top_authors": List[{"author": str, "count": int}]
      },
      "cluster_distribution": {
        "cluster-X": {"name": str, "count": int}
      }
    }
    """
      </signature>
    </interface>
    <interface name="firestore_client.get_recently_added" kind="Python Function" path="src/mcp_server/firestore_client.py">
      <signature>
def get_recently_added(limit: int = 10, days: int = 7) -> List[Dict[str, Any]]:
    """Fetch recently added chunks. Returns list sorted by added_date desc."""
      </signature>
    </interface>
    <interface name="firestore_client.get_activity_summary" kind="Python Function" path="src/mcp_server/firestore_client.py">
      <signature>
def get_activity_summary(period: str) -> Dict[str, Any]:
    """Get reading activity stats for period. Returns activity summary dict."""
      </signature>
    </interface>
    <interface name="firestore_client.get_cluster_by_id" kind="Python Function" path="src/mcp_server/firestore_client.py">
      <signature>
def get_cluster_by_id(cluster_id: str) -> Dict[str, Any] | None:
    """Fetch cluster metadata. Returns cluster dict with name, description."""
      </signature>
    </interface>
  </interfaces>

  <tests>
    <standards>
Unit tests use pytest with unittest.mock for mocking Firestore calls. Tests are located in tests/test_mcp_tools.py. Each test class follows pattern TestToolName with descriptive test method names. Mock data includes all required chunk fields plus activity summary. Tests verify both success paths and edge cases (empty results, different periods).
    </standards>
    <locations>
tests/test_mcp_tools.py - Add new TestGetRecent class alongside TestSearchKBUnified and TestGetChunk
    </locations>
    <ideas>
- AC1: Test tool registered and accessible via MCP server
- AC2: Test recent chunks returned with all fields (title, author, source, tags, snippet, chunk_info, added_date)
- AC3: Test activity summary included with total chunks, days with activity, chunks by day
- AC4: Test top sources and authors aggregation in activity summary
- AC5: Test cluster distribution calculation with cluster names
- AC6: Test knowledge cards embedded in chunk results
- AC7: Test all URL fields (readwise_url, source_url, highlight_url) present
- AC8: Test different period values ("today", "last_7_days", "last_month")
- AC9: Test custom limit parameter
- AC10: Integration test verifies tool reduces call count from 2 to 1
- Edge case: Test empty results when no recent chunks
- Edge case: Test chunks without knowledge cards (graceful None handling)
- Edge case: Test chunks in noise cluster
    </ideas>
  </tests>
</story-context>
