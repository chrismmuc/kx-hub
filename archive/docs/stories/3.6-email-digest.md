# Story 3.6: Email Digest for Reading Recommendations

Status: drafted

## Story

As a knowledge base user,
I want to receive a weekly email digest with personalized reading recommendations including one-click "Save to Reader" links,
so that I can discover relevant articles passively and immediately add them to my Readwise Reader queue from any device.

## Acceptance Criteria

1. **Scheduled delivery:** Cloud Scheduler triggers email digest on configurable schedule
   - Default: Weekly on Monday at 8:00 AM (user's timezone)
   - Options: daily, weekly, biweekly
   - Configurable via MCP tool or Firestore
2. **Rich email content:** HTML email contains top N recommendations with full context
   - Recommendation cards with title, author, domain, snippet
   - **"Why recommended"** explanation linking to user's existing KB content
   - **Related cluster** name and theme
   - **Scoring transparency:** Combined score + factor breakdown (relevance, recency, depth, authority)
   - **Publication date** prominently displayed
   - Direct link to original article
3. **Readwise Reader integration:** One-click "Save to Reader" buttons for each article
   - **Desktop deep link:** `https://readwise.io/reader/save?url={encoded_url}&tags={tags}`
   - **Mobile deep link:** `readwise://save?url={encoded_url}` (opens Reader app directly)
   - Auto-tags: cluster name + "kx-digest" + week number
   - Both link types shown per recommendation (icon-based: laptop/phone icons)
4. **SendGrid integration:** Email delivered via SendGrid API
   - Transactional email template
   - Sender: configurable (default: noreply@kx-hub)
   - Uses SendGrid free tier (~100 emails/day)
5. **Configuration management:** Firestore `config/email_digest` document
   - `enabled`: boolean (default: false)
   - `schedule`: "daily" | "weekly" | "biweekly"
   - `day_of_week`: 0-6 (Monday=0, for weekly)
   - `hour`: 0-23 (in user's timezone)
   - `timezone`: string (e.g., "Europe/Berlin")
   - `recipient_email`: string
   - `recommendation_count`: number (default: 5)
   - `include_scoring_details`: boolean (default: true)
   - `readwise_tags_prefix`: string (default: "kx-")
6. **MCP tool for configuration:** `configure_email_digest(enabled, schedule, email, ...)`
   - Enable/disable digest
   - Update schedule and preferences
   - Test send (immediate delivery for testing)
7. **Unsubscribe mechanism:** One-click unsubscribe link in email footer
   - Disables digest without requiring login
   - Secure token-based unsubscribe
8. **Error handling:** Graceful failure with logging
   - Retry on SendGrid API errors (max 3 attempts)
   - Alert on repeated failures
   - Skip digest if no new recommendations
9. **Responsive design:** Email renders correctly on mobile and desktop
   - Gmail, Outlook, Apple Mail tested
   - Dark mode compatible
   - Mobile-optimized "Save to Reader" buttons (large tap targets)
10. **Digest summary section:** Email header with digest metadata
    - Week/date range covered
    - Total articles analyzed
    - Clusters represented
    - Link to configure preferences

## Tasks / Subtasks

- [ ] Task 1: Set up SendGrid integration (AC: #4)
  - [ ] Create SendGrid account and verify sender domain
  - [ ] Obtain API key and store in Secret Manager (`/kx-hub/sendgrid/api-key`)
  - [ ] Create `functions/email_digest/sendgrid_client.py`
  - [ ] Implement `send_email(to, subject, html_content)` method
  - [ ] Add retry logic with exponential backoff
  - [ ] Test with sample email

- [ ] Task 2: Create email HTML template (AC: #2, #9, #10)
  - [ ] Design responsive HTML template for recommendations
  - [ ] Create digest header section with metadata (week, clusters, article count)
  - [ ] Create recommendation card component with:
    - [ ] Title, author, domain, publication date
    - [ ] Snippet (truncated to ~200 chars)
    - [ ] "Why recommended" explanation
    - [ ] Related cluster badge
    - [ ] Scoring breakdown (optional, configurable)
  - [ ] Add Readwise Reader buttons (Task 3)
  - [ ] Add kx-hub branding header
  - [ ] Add unsubscribe footer
  - [ ] Test across email clients (Gmail, Outlook, Apple Mail)
  - [ ] Verify dark mode compatibility
  - [ ] Store template in `functions/email_digest/templates/`

- [ ] Task 3: Implement Readwise Reader deep links (AC: #3)
  - [ ] Research Readwise Reader URL schemes:
    - [ ] Desktop: `https://readwise.io/reader/save?url={url}&tags={tags}`
    - [ ] Mobile iOS: `readwise://save?url={url}`
    - [ ] Mobile Android: `intent://...` or universal link
  - [ ] Create `generate_reader_links(url, tags)` helper function
  - [ ] URL-encode article URL and tags properly
  - [ ] Generate auto-tags: `{cluster-slug}, kx-digest, {year}-W{week}`
  - [ ] Add desktop button with laptop icon (ðŸ’»)
  - [ ] Add mobile button with phone icon (ðŸ“±)
  - [ ] Style buttons for large tap targets on mobile (min 44x44px)
  - [ ] Test deep links on iOS and Android devices

- [ ] Task 4: Implement scoring display (AC: #2)
  - [ ] Create scoring breakdown component for email template
  - [ ] Display combined score as percentage or bar
  - [ ] Show factor breakdown: relevance, recency, depth, authority
  - [ ] Use visual indicators (bars, badges, or percentages)
  - [ ] Make display configurable via `include_scoring_details` setting
  - [ ] Ensure scoring info doesn't clutter mobile view

- [ ] Task 5: Implement digest configuration (AC: #5)
  - [ ] Create Firestore document `config/email_digest`
  - [ ] Add `get_email_digest_config()` to firestore helpers
  - [ ] Add `update_email_digest_config()` to firestore helpers
  - [ ] Implement timezone handling
  - [ ] Validate schedule parameters
  - [ ] Add new config fields: `include_scoring_details`, `readwise_tags_prefix`

- [ ] Task 6: Implement Cloud Function for digest (AC: #1, #8)
  - [ ] Create `functions/email_digest/main.py`
  - [ ] Integrate with Story 3.5 + 3.8 recommendation engine
  - [ ] Load config from Firestore
  - [ ] Generate Readwise Reader links for each recommendation
  - [ ] Render email HTML from template with all data
  - [ ] Send via SendGrid
  - [ ] Log success/failure metrics
  - [ ] Handle "no recommendations" case gracefully

- [ ] Task 7: Set up Cloud Scheduler (AC: #1)
  - [ ] Define Terraform resource for Cloud Scheduler job
  - [ ] Configure Pub/Sub topic for trigger
  - [ ] Set initial schedule (weekly Monday 8am)
  - [ ] Add job enable/disable capability

- [ ] Task 8: Implement MCP configuration tool (AC: #6)
  - [ ] Add `configure_email_digest()` to `src/mcp_server/tools.py`
  - [ ] Register tool in `main.py`
  - [ ] Implement test send functionality
  - [ ] Validate email format
  - [ ] Return confirmation with next scheduled send

- [ ] Task 9: Implement unsubscribe mechanism (AC: #7)
  - [ ] Generate secure unsubscribe tokens
  - [ ] Create Cloud Function endpoint for unsubscribe
  - [ ] Add unsubscribe link to email template
  - [ ] Update config on unsubscribe
  - [ ] Show confirmation page

- [ ] Task 10: Testing and documentation (AC: #1-10)
  - [ ] Unit tests for SendGrid client
  - [ ] Unit tests for template rendering
  - [ ] Unit tests for Readwise link generation
  - [ ] Integration test: End-to-end digest flow
  - [ ] Test Readwise deep links on iOS, Android, Desktop
  - [ ] Test schedule configurations
  - [ ] Update `docs/mcp-server-usage.md`
  - [ ] Document email template customization

## Dev Notes

### Architecture

**Processing Flow:**
```
Cloud Scheduler (cron)
    â”‚
    â–¼
Pub/Sub Topic: email-digest-trigger
    â”‚
    â–¼
Cloud Function: email-digest
    â”‚
    â”œâ”€â†’ Load config from Firestore
    â”œâ”€â†’ Check if enabled
    â”œâ”€â†’ Call recommendation engine (Story 3.5 + 3.8 logic)
    â”œâ”€â†’ Generate Readwise Reader deep links for each article
    â”œâ”€â†’ Render HTML template with full scoring data
    â”œâ”€â†’ Send via SendGrid API
    â””â”€â†’ Log metrics
```

**Terraform Resources:**
```hcl
# Cloud Scheduler job
resource "google_cloud_scheduler_job" "email_digest" {
  name     = "email-digest-weekly"
  schedule = "0 8 * * 1"  # Monday 8am
  ...
}

# Pub/Sub topic
resource "google_pubsub_topic" "email_digest_trigger" {
  name = "email-digest-trigger"
}
```

**Firestore Config (`config/email_digest`):**
```json
{
  "enabled": true,
  "schedule": "weekly",
  "day_of_week": 0,
  "hour": 8,
  "timezone": "Europe/Berlin",
  "recipient_email": "user@example.com",
  "recommendation_count": 5,
  "include_scoring_details": true,
  "readwise_tags_prefix": "kx-",
  "last_sent": "2025-12-08T08:00:00Z",
  "unsubscribe_token": "secure-random-token"
}
```

### Readwise Reader Deep Links

**URL Schemes by Platform:**

| Platform | URL Scheme | Example |
|----------|------------|---------|
| Desktop (Web) | `https://readwise.io/reader/save?url={url}&tags={tags}` | Opens Reader web, saves article |
| iOS App | `readwise://save?url={url}` | Opens Reader iOS app directly |
| Android App | `https://readwise.io/reader/save?url={url}` | Universal link opens app if installed |

**Link Generation Function:**
```python
from urllib.parse import quote
from datetime import datetime

def generate_reader_links(
    article_url: str,
    cluster_name: str,
    tags_prefix: str = "kx-"
) -> dict:
    """
    Generate Readwise Reader deep links for an article.

    Returns desktop and mobile URLs with auto-generated tags.
    """
    # Auto-generate tags
    week_number = datetime.now().isocalendar()[1]
    year = datetime.now().year
    cluster_slug = cluster_name.lower().replace(" ", "-")[:30]

    tags = [
        cluster_slug,
        f"{tags_prefix}digest",
        f"{year}-W{week_number:02d}"
    ]
    tags_param = quote(",".join(tags))
    encoded_url = quote(article_url, safe="")

    return {
        "desktop": f"https://readwise.io/reader/save?url={encoded_url}&tags={tags_param}",
        "mobile_ios": f"readwise://save?url={encoded_url}",
        "mobile_universal": f"https://readwise.io/reader/save?url={encoded_url}&tags={tags_param}"
    }
```

**Example Generated Links:**
```
Article: https://martinfowler.com/articles/platform-engineering.html
Cluster: Platform Engineering

Desktop:
https://readwise.io/reader/save?url=https%3A%2F%2Fmartinfowler.com%2Farticles%2Fplatform-engineering.html&tags=platform-engineering%2Ckx-digest%2C2025-W50

Mobile (iOS):
readwise://save?url=https%3A%2F%2Fmartinfowler.com%2Farticles%2Fplatform-engineering.html
```

### Email Template Structure

**Recommendation Card HTML (Conceptual):**
```html
<div class="recommendation-card">
  <!-- Header: Title + Meta -->
  <h3 class="title">
    <a href="{article_url}">{title}</a>
  </h3>
  <div class="meta">
    <span class="author">{author}</span> Â·
    <span class="domain">{domain}</span> Â·
    <span class="date">{published_date}</span>
  </div>

  <!-- Snippet -->
  <p class="snippet">{snippet_200_chars}...</p>

  <!-- Cluster Badge -->
  <span class="cluster-badge">ðŸ“š {cluster_name}</span>

  <!-- Why Recommended -->
  <div class="why-recommended">
    <strong>Why this?</strong> {why_recommended}
  </div>

  <!-- Scoring (optional) -->
  <div class="scoring" style="{display if include_scoring_details}">
    <div class="score-bar">
      <span class="score-label">Score: {combined_score}%</span>
      <div class="score-breakdown">
        Relevance: {relevance}% Â· Recency: {recency}% Â·
        Depth: {depth}% Â· Authority: {authority}%
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="actions">
    <a href="{article_url}" class="btn btn-primary">
      ðŸ“– Read Article
    </a>
    <a href="{reader_desktop_link}" class="btn btn-secondary">
      ðŸ’» Save to Reader (Desktop)
    </a>
    <a href="{reader_mobile_link}" class="btn btn-secondary">
      ðŸ“± Save to Reader (Mobile)
    </a>
  </div>
</div>
```

**Digest Header Section:**
```html
<div class="digest-header">
  <h1>ðŸ“¬ Your Weekly Knowledge Digest</h1>
  <p class="digest-meta">
    Week {week_number}, {year} Â· {recommendation_count} recommendations Â·
    From {cluster_count} knowledge clusters
  </p>
  <p class="digest-summary">
    Based on {total_articles_analyzed} articles matching your interests
  </p>
</div>
```

### Email Content Data Structure

**Data passed to template:**
```json
{
  "digest_meta": {
    "week_number": 50,
    "year": 2025,
    "date_range": "Dec 9-15, 2025",
    "recommendation_count": 5,
    "cluster_count": 4,
    "total_articles_analyzed": 47
  },
  "config": {
    "include_scoring_details": true,
    "readwise_tags_prefix": "kx-"
  },
  "recommendations": [
    {
      "title": "The Future of Platform Engineering",
      "url": "https://martinfowler.com/articles/...",
      "author": "Martin Fowler",
      "domain": "martinfowler.com",
      "published_date": "2025-12-10",
      "snippet": "Platform engineering has evolved from...",
      "cluster": {
        "id": "cluster-28",
        "name": "Platform Engineering",
        "slug": "platform-engineering"
      },
      "why_recommended": "Expands on your recent reading about internal developer platforms and connects to your highlights on cognitive load reduction.",
      "scoring": {
        "combined_score": 0.847,
        "combined_percent": 85,
        "breakdown": {
          "relevance": 0.92,
          "recency": 0.89,
          "depth": 0.80,
          "authority": 0.75
        },
        "breakdown_percent": {
          "relevance": 92,
          "recency": 89,
          "depth": 80,
          "authority": 75
        }
      },
      "reader_links": {
        "desktop": "https://readwise.io/reader/save?url=...",
        "mobile_ios": "readwise://save?url=...",
        "mobile_universal": "https://readwise.io/reader/save?url=..."
      }
    }
  ],
  "unsubscribe_url": "https://kx-hub.example.com/unsubscribe?token=..."
}

### Project Structure Notes

**New Files:**
- `functions/email_digest/main.py` - Cloud Function entry point
- `functions/email_digest/sendgrid_client.py` - SendGrid API wrapper
- `functions/email_digest/templates/digest.html` - Email template
- `terraform/email_digest.tf` - Infrastructure definition
- `tests/test_email_digest.py` - Unit tests

**Files to Modify:**
- `src/mcp_server/tools.py` - Add `configure_email_digest()`
- `src/mcp_server/main.py` - Register tool
- `src/mcp_server/firestore_client.py` - Add config methods
- `terraform/main.tf` - Reference email_digest module

### Dependencies

- **Story 3.5** (Reading Recommendations): Provides base recommendation engine
- **Story 3.8** (Enhanced Ranking): Provides recency scoring and diversity features
- **Story 3.7** (Save to Reader): Shares Readwise Reader API knowledge
- **SendGrid**: Free tier allows 100 emails/day
- **Secret Manager**: Store SendGrid API key

### Cost Analysis

| Component | Monthly Cost |
|-----------|-------------|
| SendGrid | $0 (free tier: 100/day) |
| Cloud Scheduler | $0 (3 free jobs) |
| Cloud Function | ~$0.01 (4 invocations/month) |
| **Total** | **~$0.01/month** |

### References

- [Source: docs/epics.md#Story-3.6] - Story requirements
- [Source: docs/architecture.md] - Pipeline architecture patterns
- [Source: docs/stories/3.5-reading-recommendations.md] - Recommendation engine
- [Source: docs/stories/3.8-enhanced-recommendation-ranking.md] - Ranking algorithm
- [SendGrid API Docs](https://docs.sendgrid.com/api-reference) - Email API
- [Readwise Reader API](https://readwise.io/api_deets) - Reader integration

## Dev Agent Record

### Context Reference

<!-- Path(s) to story context XML will be added here by context workflow -->

### Agent Model Used

Claude Opus 4.5

### Debug Log References

### Completion Notes List

### File List
