<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2.6</storyId>
    <title>MCP Server Enhancements - Knowledge Cards & Clusters</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-13</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/2.6-mcp-enhancements.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>knowledge base user querying via Claude Desktop</asA>
    <iWant>the MCP server to expose knowledge cards and cluster metadata in search results and provide cluster-based browsing tools</iWant>
    <soThat>I can quickly scan AI-generated summaries, discover topics via clustering, and navigate my knowledge base by semantic themes instead of just keyword search</soThat>
    <tasks>
      <task id="1">Extend existing MCP tools with knowledge cards and cluster data</task>
      <task id="2">Implement knowledge card tools (get_knowledge_card, search_knowledge_cards)</task>
      <task id="3">Implement cluster discovery tools (list_clusters, get_cluster, search_within_cluster)</task>
      <task id="4">Implement cluster resources (kxhub://clusters, kxhub://cluster/{id}, kxhub://cluster/{id}/cards)</task>
      <task id="5">Update Firestore client queries to fetch knowledge_card and cluster fields</task>
      <task id="6">Testing and validation (unit, integration, performance, manual)</task>
      <task id="7">Documentation and deployment</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Enhanced search results: All existing search tools include knowledge_card and cluster fields in response objects</criterion>
    <criterion id="2">Knowledge card tools functional: get_knowledge_card(chunk_id) and search_knowledge_cards(query) work correctly</criterion>
    <criterion id="3">Cluster discovery tools functional: list_clusters(), get_cluster(id), search_within_cluster(id, query) work correctly</criterion>
    <criterion id="4">Cluster resources browsable: kxhub://clusters, kxhub://cluster/{id}, kxhub://cluster/{id}/cards available in Claude Desktop</criterion>
    <criterion id="5">Performance: All new tools respond in &lt;1 second (P95)</criterion>
    <criterion id="6">Backward compatibility: No breaking changes to existing MCP tools</criterion>
    <criterion id="7">Zero cost increase: Reuses existing Firestore data (knowledge_card, cluster_id fields)</criterion>
    <criterion id="8">Data completeness: Handle edge cases gracefully (missing knowledge cards, missing clusters, noise cluster)</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/mcp-server-usage.md</path>
        <title>MCP Server Usage Guide</title>
        <section>Available Tools</section>
        <snippet>Describes existing MCP tools: search_semantic, search_by_metadata, get_related_chunks, get_stats. Story 2.6 extends these tools with knowledge_card and cluster fields.</snippet>
      </doc>
      <doc>
        <path>docs/architecture/mcp-integration.md</path>
        <title>MCP Integration Architecture</title>
        <section>Architecture Diagram</section>
        <snippet>MCP server architecture with Resources, Tools, and Prompts sections. Connects to Firestore via Google Cloud APIs for kb_items collection with 768-dim embeddings.</snippet>
      </doc>
      <doc>
        <path>docs/epic-2-prd.md</path>
        <title>Epic 2 PRD - Enhanced Knowledge Graph &amp; Clustering</title>
        <section>Core Use Cases</section>
        <snippet>Semantic clustering, knowledge card generation, and cluster synthesis features. Story 2.6 exposes these data structures via MCP server.</snippet>
      </doc>
      <doc>
        <path>docs/stories/2.1-knowledge-cards.md</path>
        <title>Story 2.1 - Knowledge Cards Generation</title>
        <section>Implementation</section>
        <snippet>Knowledge card structure: {summary: string, takeaways: string[]}. All 818 chunks have knowledge cards stored in kb_items.knowledge_card field.</snippet>
      </doc>
      <doc>
        <path>docs/stories/2.2-semantic-clustering.md</path>
        <title>Story 2.2 - Semantic Clustering</title>
        <section>Implementation</section>
        <snippet>Cluster data schema: kb_items.cluster_id (array), clusters collection with metadata (name, description, size, centroid). 38 clusters created using HDBSCAN.</snippet>
      </doc>
      <doc>
        <path>docs/stories/1.7.story.md</path>
        <title>Story 1.7 - MCP Server Implementation</title>
        <section>Architecture</section>
        <snippet>Established MCP server patterns: tool registration, resource handlers, Firestore client integration. Story 2.6 extends these existing patterns.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/mcp_server/tools.py</path>
        <kind>module</kind>
        <symbol>search_semantic, search_by_metadata, get_related_chunks</symbol>
        <lines>23-100+</lines>
        <reason>Core MCP tools to extend with knowledge_card and cluster fields. Contains existing search result formatting logic.</reason>
      </artifact>
      <artifact>
        <path>src/mcp_server/firestore_client.py</path>
        <kind>module</kind>
        <symbol>find_nearest, query_by_metadata, get_chunk_by_id</symbol>
        <lines>1-200+</lines>
        <reason>Firestore query layer to update with knowledge_card and cluster_id field fetching. Provides vector search and metadata filtering.</reason>
      </artifact>
      <artifact>
        <path>src/mcp_server/resources.py</path>
        <kind>module</kind>
        <symbol>list_resources, read_resource</symbol>
        <lines>1-80+</lines>
        <reason>Resource handlers to extend with cluster resources (kxhub://clusters, kxhub://cluster/{id}). Pattern for URI-based browsing.</reason>
      </artifact>
      <artifact>
        <path>src/mcp_server/main.py</path>
        <kind>module</kind>
        <symbol>list_tools_handler, call_tool_handler</symbol>
        <lines>79-200+</lines>
        <reason>MCP server entry point where new tools must be registered (list_tools) and routed (call_tool).</reason>
      </artifact>
      <artifact>
        <path>src/clustering/cluster_metadata.py</path>
        <kind>module</kind>
        <symbol>cluster metadata generation</symbol>
        <lines>1-100+</lines>
        <reason>Reference for cluster data structure (name, description, size). MCP server reads this data from Firestore clusters collection.</reason>
      </artifact>
    </code>
    <dependencies>
      <python>
        <package name="mcp" version=">=0.9.0">Model Context Protocol SDK</package>
        <package name="google-cloud-firestore" version=">=2.14.0">Firestore client with vector search support</package>
        <package name="google-cloud-aiplatform" version=">=1.38.0">Vertex AI for embeddings generation</package>
        <package name="python-dotenv" version=">=1.0.0">Environment configuration</package>
      </python>
      <frameworks>
        <framework>MCP (Model Context Protocol) - stdio transport for Claude Desktop integration</framework>
        <framework>Google Cloud Firestore - NoSQL database with vector search</framework>
        <framework>Vertex AI - Embedding generation (text-embedding-004 model)</framework>
      </frameworks>
    </dependencies>
  </artifacts>

  <constraints>
    - No breaking changes to existing MCP tools (backward compatibility required)
    - All new tools must follow existing MCP server patterns (tool registration, error handling, logging)
    - Firestore queries must include knowledge_card and cluster_id fields without performance degradation
    - Response times must stay under 1 second P95 (performance requirement)
    - Edge cases must be handled gracefully: missing knowledge_card, missing cluster_id, noise cluster
    - New resource URIs must follow kxhub:// pattern established in Story 1.7
    - Code must follow Python type hints and existing code style in src/mcp_server/
    - All Firestore reads are read-only operations (no writes from MCP server)
    - Zero cost increase constraint: reuse existing Firestore data, no new AI API calls
  </constraints>
  <interfaces>
    <interface>
      <name>MCP Tool Interface</name>
      <kind>Python async function</kind>
      <signature>async def tool_name(param1: type, param2: type = default) -&gt; Dict[str, Any]</signature>
      <path>src/mcp_server/main.py</path>
    </interface>
    <interface>
      <name>Firestore kb_items.knowledge_card</name>
      <kind>Firestore document field</kind>
      <signature>knowledge_card: {summary: str, takeaways: List[str]}</signature>
      <path>Firestore kb_items collection</path>
    </interface>
    <interface>
      <name>Firestore kb_items.cluster_id</name>
      <kind>Firestore document field</kind>
      <signature>cluster_id: List[str] (array of cluster IDs)</signature>
      <path>Firestore kb_items collection</path>
    </interface>
    <interface>
      <name>Firestore clusters collection</name>
      <kind>Firestore collection</kind>
      <signature>{id: str, name: str, description: str, size: int, centroid: Vector, created_at: Timestamp}</signature>
      <path>Firestore clusters collection</path>
    </interface>
    <interface>
      <name>MCP Resource URI Pattern</name>
      <kind>URI pattern</kind>
      <signature>kxhub://resource-type/resource-id</signature>
      <path>src/mcp_server/resources.py</path>
    </interface>
  </interfaces>
  <tests>
    <standards>Python unittest framework for unit tests. Integration tests connect to Firestore test collection. Performance tests measure P95 response times (target &lt;1s). Manual validation with Claude Desktop to verify user experience.</standards>
    <locations>tests/mcp_server/ - Unit and integration tests for MCP tools and resources</locations>
    <ideas>
      <idea criterionId="1">Unit test: Verify search_semantic response includes knowledge_card and cluster fields</idea>
      <idea criterionId="2">Unit test: Test get_knowledge_card with valid chunk_id returns summary and takeaways</idea>
      <idea criterionId="2">Unit test: Test search_knowledge_cards returns only summaries, not full content</idea>
      <idea criterionId="3">Unit test: Test list_clusters returns all clusters sorted by size</idea>
      <idea criterionId="3">Unit test: Test get_cluster with valid cluster_id returns metadata and members</idea>
      <idea criterionId="3">Unit test: Test search_within_cluster filters results to cluster members</idea>
      <idea criterionId="4">Integration test: Verify cluster resource URIs load in Claude Desktop</idea>
      <idea criterionId="5">Performance test: Measure P95 response time for all 8 tools (3 enhanced + 5 new)</idea>
      <idea criterionId="6">Integration test: Verify existing MCP tools still work without breaking changes</idea>
      <idea criterionId="8">Unit test: Handle missing knowledge_card field gracefully</idea>
      <idea criterionId="8">Unit test: Handle missing cluster_id field gracefully</idea>
      <idea criterionId="8">Unit test: Handle noise cluster appropriately</idea>
    </ideas>
  </tests>
</story-context>
