version: '3.8'

services:
  # Firestore Emulator
  firestore:
    image: gcr.io/google.com/cloudsdktool/google-cloud-cli:latest
    command: gcloud emulators firestore start --host-port=0.0.0.0:8080
    ports:
      - "8080:8080"
    environment:
      - FIRESTORE_PROJECT_ID=kx-hub-local

  # Python Tools API
  tools-api:
    build:
      context: .
      dockerfile: Dockerfile.mcp-tools-api
    ports:
      - "8081:8080"
    environment:
      - PORT=8080
      - FIRESTORE_EMULATOR_HOST=firestore:8080
      - GCP_PROJECT=kx-hub-local
    depends_on:
      - firestore

  # Python OAuth Server
  oauth-server:
    build:
      context: .
      dockerfile: Dockerfile.oauth-service
    ports:
      - "8082:8080"
    environment:
      - PORT=8080
      - FIRESTORE_EMULATOR_HOST=firestore:8080
      - GCP_PROJECT=kx-hub-local
      - OAUTH_USER_EMAIL=chrismu82@googlemail.com
      - OAUTH_USER_PASSWORD_HASH=$$2b$$12$$E/voXAj5L90n0xWWQeiu9OfAs.2YDX5a7GL.zGF5x2z3H/15eGWwu
      - JWT_PRIVATE_KEY_FILE=/secrets/jwt-private-key.pem
    volumes:
      - ./secrets:/secrets:ro
    depends_on:
      - firestore

  # TypeScript MCP Server
  mcp-server:
    build:
      context: .
      dockerfile: Dockerfile.mcp-server-ts
    ports:
      - "8083:8080"
    environment:
      - PORT=8080
      - PYTHON_TOOLS_API_URL=http://tools-api:8080
      - OAUTH_LAMBDA_URL=http://oauth-server:8080
    volumes:
      - ./secrets:/secrets:ro
    depends_on:
      - tools-api
      - oauth-server
