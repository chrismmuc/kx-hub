# Story 2.5: Storage Permissions for Graph Export (Infrastructure Setup)

## Status: READY FOR APPROVAL ✅
**Epic:** 2 - AI-Powered Knowledge Processing
**Dependencies:** Story 2.3 (Clustering Consistency)
**Priority:** HIGH (Prepares infrastructure for future graph features)

---

## Problem Statement

**Missing infrastructure permission for future graph export features:**
- Service account (mcp-server-sa) lacks `storage.objects.create` permission at project level
- This will be needed when Story 3.2 (Graph Regeneration) requires uploading graph.json
- Least privilege approach: grant write-only access, not admin access

**Root Cause:**
mcp-server-sa has bucket-level storage.objectAdmin (via bucket IAM), but lacks project-level storage.objectCreator role needed for Cloud Storage operations initiated from initial_load.py.

---

## Solution Overview

Grant `roles/storage.objectCreator` to mcp-server-sa service account at the project level.

**Note:** Graph generation code has been removed from `initial_load.py` (deferred to Story 3.2). This story grants the infrastructure permission needed when Story 3.2 implements graph regeneration.

### Why This Matters

- ✅ Prepares infrastructure for Story 3.2 (Graph Regeneration on Delta)
- ✅ Infrastructure-first approach: permissions deployed before feature code
- ✅ Enables graph.json uploads when smart regeneration is implemented
- ✅ Least privilege approach: object creator (write), not admin (delete)

---

## Technical Implementation

### Terraform Change

Update `terraform/main.tf` to grant storage object creator role:

```hcl
# Grant MCP server project-level storage object creator permission
resource "google_project_iam_member" "mcp_sa_storage_object_creator" {
  project = var.project_id
  role    = "roles/storage.objectCreator"
  member  = "serviceAccount:${google_service_account.mcp_server_sa.email}"
}
```

**Permissions granted:**
- `storage.objects.create` - Create new objects in Cloud Storage
- `storage.objects.delete` - Overwrite existing objects

---

## Acceptance Criteria

- [x] Terraform updated with storage.objectCreator role
- [x] `terraform plan` shows mcp_sa_storage_object_creator resource
- [x] `terraform apply` successfully deploys IAM change
- [x] IAM verification: mcp-server-sa has roles/storage.objectCreator
- [x] Graph generation code removed from initial_load.py (deferred to 3.2)

---

## Testing

### Prerequisites
```bash
export GCP_PROJECT=kx-hub
export GCP_REGION=europe-west4
export FIRESTORE_COLLECTION=kb_items
export GOOGLE_APPLICATION_CREDENTIALS=/path/to/mcp-server-key.json
```

### Test Upload Permission
```bash
# Verify permission was granted
gcloud projects get-iam-policy kx-hub \
    --flatten="bindings[].members" \
    --filter="bindings.members:mcp-server-sa@kx-hub.iam.gserviceaccount.com" \
    --format="table(bindings.role)"

# Should show:
# roles/aiplatform.user
# roles/datastore.user
# roles/storage.objectCreator  ← NEW
```

### Test initial_load.py Runs Successfully
```bash
# Run initial load clustering (should complete without permission errors)
python3 -m src.clustering.initial_load --dry-run

# Check for successful completion
# Should show: [Step 1/4], [Step 2/4], [Step 3/4], [Step 4/4]
# (Graph generation deferred to Story 3.2)
```

**Expected output:**
```
✅ INITIAL LOAD CLUSTERING - COMPLETE
[Step 1/4] Loading chunks with embeddings...
[Step 2/4] Clustering...
[Step 3/4] Saving UMAP model...
[Step 4/4] Updating Firestore...
```

---

## Implementation Steps

1. ✅ Terraform Updated - Added IAM resource in `/terraform/main.tf`
2. ✅ Deployed terraform changes: `terraform apply` successful
3. ✅ Verified IAM role: mcp-server-sa has roles/storage.objectCreator
4. ✅ Cleaned up initial_load.py - Removed graph generation (deferred to 3.2)
5. ✅ Tested initial_load.py - Runs successfully with 4 steps (was 5)

---

## Related Stories

- **Story 2.3**: Clustering Consistency Fix (creates graph.json)
- **Story 2.4**: Knowledge Cards Consistency Check (completed)
- **Story 3.2**: Graph Regeneration on Delta (deferred, future feature)

---

## Implementation Summary

### What Changed
1. **IAM Permissions** ✅
   - Added `roles/storage.objectCreator` to mcp-server-sa at project level
   - Deployed via Terraform (terraform/main.tf lines 614-620)
   - Verified successfully applied

2. **Code Cleanup** ✅
   - Removed graph generation from src/clustering/initial_load.py
   - Removed GraphGenerator import
   - Updated workflow from 5 steps → 4 steps
   - Keep graph_generator.py for use in Story 3.2

3. **Scope Clarification** ✅
   - Story 2.5: Infrastructure setup only (IAM permissions)
   - Story 3.2: Feature implementation (smart graph regeneration)
   - Separation of concerns: infrastructure ≠ feature code

---

**Story 2.5: COMPLETE AND READY FOR APPROVAL**

**Summary:**
Infrastructure preparation complete. IAM permissions in place for when Story 3.2 implements graph regeneration on delta clustering. Initial load clustering now focuses on its core responsibility: loading, clustering, and persisting chunk data.
