# Story 3.1: Remote MCP Server (Personal, Secure Access)

Status: DRAFT  
**Epic:** 3 - Advanced Knowledge Graph & System Optimization  
**Dependencies:** Story 2.6 (MCP Enhancements) ✅ COMPLETE  
**Priority:** MEDIUM (unblocks remote/ChatGPT use of KB)

## Story

As the single owner of kx-hub,  
I want to expose my MCP server over the internet with simple but strong protection,  
so that I can use it remotely (e.g., ChatGPT connectors) without running local tunnels, while keeping my data private.

## Acceptance Criteria

1. **Reachable over HTTPS:** MCP SSE endpoint is publicly reachable via HTTPS on a stable URL (Cloud Run or equivalent) with valid TLS.  
2. **Single-user authentication:** Requests must include a shared secret (e.g., `Authorization: Bearer <token>`) stored in Secret Manager; requests without it return 401. No multi-user flows required.  
3. **Least-privilege service account:** Deployed service account is restricted to read-only KB access (Firestore `kb_items`, `clusters`) plus only the minimum additional APIs (Vertex not required).  
4. **Config via env/secrets only:** No secrets baked into images; token and Firestore project/collection names are pulled from env vars or Secret Manager at runtime.  
5. **Observability:** Access logs capture caller IP, path, latency, and auth outcome; 4xx/5xx rates visible in Cloud Logging with one alert for sustained 5xx.  
6. **Security smoke tests:**  
   - Valid token request returns 200 for `list_tools`.  
   - Missing/invalid token request returns 401.  
   - CORS disabled (not needed for connector use).  
7. **Docs for ChatGPT connector:** Short setup note describing the endpoint URL, required header, and how to add it as a custom connector in ChatGPT developer mode.

## Tasks / Subtasks

- [ ] Task 1: Define deployment & auth shape (AC #1, #2)  
  - Pick Cloud Run (HTTPS, autoscale to zero).  
  - Choose header name/value and Secret Manager key; document env vars.

- [ ] Task 2: Package MCP server for Cloud Run (AC #1, #4)  
  - Add minimal Dockerfile and entrypoint to run `src/mcp_server/main.py` with SSE.  
  - Parametrize project/collection/token via env.

- [ ] Task 3: Secure runtime (AC #2, #3)  
  - Create service account with read-only Firestore IAM roles.  
  - Bind Secret Manager accessor for the token.  
  - Implement middleware that enforces Bearer token on all routes.

- [ ] Task 4: Deploy & wire secrets (AC #1, #4)  
  - Deploy Cloud Run service with HTTPS only, min instances = 0, CPU throttling.  
  - Inject secrets via `--set-secrets` or `Secret Manager` volumes.  
  - Disable unauthenticated if using IAP; otherwise keep public but token-protected.

- [ ] Task 5: Observability & alert (AC #5)  
  - Enable request logging; add metric-based alert for 5xx > 5/min over 5 min.  
  - Optional: log auth failures without leaking token value.

- [ ] Task 6: Security smoke tests (AC #6)  
  - Curl with valid token → 200 on `list_tools`.  
  - Curl without/invalid token → 401.  
  - Confirm CORS not set.

- [ ] Task 7: Connector how-to (AC #7)  
  - Add short doc/snippet in README or `docs/mcp-remote.md` with endpoint URL, header to copy, and ChatGPT connector steps.
