---
epicNum: 1
storyNum: 5
title: "Vertex AI gRPC Upsert Upgrade"
status: "InProgress"
---

# Story: Vertex AI gRPC Upsert Upgrade

As a **pipeline maintainer**, I want **the embed stage to use the official Vertex AI gRPC client with supported SDK versions**, so that **vector upserts succeed reliably in production without REST fallback errors**.

## Acceptance Criteria

1. Bump `google-cloud-aiplatform` in `src/embed/requirements.txt` to a version that ships `IndexServiceClient` (≥ 1.44) and document the minimum version in configuration references.
2. Refactor `src/embed/main.py` so both single and batch upserts call the Vertex AI gRPC `IndexServiceClient.upsert_datapoints` API and remove the HTTP fallback; preserve existing retry/backoff semantics and crowding tag behaviour. **CRITICAL:** IndexDatapoint must be constructed with keyword arguments (datapoint_id=, feature_vector=) and CrowdingTag with IndexDatapoint.CrowdingTag(crowding_attribute=).
3. Update `tests/test_embed.py` to exercise the gRPC client path for success and failure cases (single + batch), ensuring REST sessions are no longer invoked and logging assertions remain valid.
4. Refresh architecture and PRD docs to reflect the gRPC client requirement and the upgraded dependency, including operational steps in `verify-deployment.sh` if needed.
5. After redeploying the embed function, trigger the daily ingest scheduler (or equivalent manual run) and capture evidence that normalize completes and embed succeeds without 404 responses from Vertex AI.

## Dev Notes

- **Previous Story Insights**
  - Delta processing now depends on manifest-driven `run_id` propagation and stale `processing` resets; the embed refactor must remain compatible with these Firestore state transitions. [Source: docs/stories/1.4.story.md#dev-notes]
  - The embed function already parses markdown, calls Vertex AI embeddings, and syncs Vector Search + Firestore; this story replaces only the Vector Search upsert transport. [Source: docs/stories/1.3.story.md#dev-notes]
- **Architecture Guidance**
  - Batch pipeline Step 3 (F3) is owned by the embed function and is invoked by Cloud Workflows after normalize. [Source: docs/architecture/system-architecture.md#batch-processing-pipeline-daily]
  - All AI integrations are consolidated on Vertex AI (embeddings, vector search), so adopting the official gRPC client aligns with the single-provider strategy. [Source: docs/architecture/ai-provider-integration-vertex-ai.md#architecture]
- **Data Models**
  - `kb_items` stores metadata plus embedding status fields that must continue to update atomically with gRPC upserts. [Source: docs/prd/5-data-model-brief.md#5-data-model-brief]
  - `pipeline_items` retains `embedding_status`, `retry_count`, and `manifest_run_id`; ensure gRPC errors feed the same status transitions used today. [Source: docs/prd/5-data-model-brief.md#5-data-model-brief]
- **API Specifications**
  - Workflow Step 3 pulls pending items from `pipeline_items` and writes embeddings back to Vector Search + Firestore; the gRPC upgrade should keep the same input/output contract while switching transport. [Source: docs/prd/4-data-flows.md#batch-processing-pipeline-daily]
  - The Vertex AI Vector Search service expects `datapoint_id`, `feature_vector`, and optional `crowding_tag`; these map directly to gRPC request structures. [Source: docs/architecture/ai-provider-integration-vertex-ai.md#architecture]
- **Testing Requirements**
  - Maintain the test-first discipline established in the embed story (unit coverage for embeddings, vector search, Firestore writes). [Source: docs/stories/1.3.story.md#dev-notes]
  - No dedicated architecture testing standard is documented beyond existing story guidance; keep tests under `tests/test_embed.py`. [Source: docs/architecture/index.md]
- **File Locations**
  - Embed Cloud Function code: `src/embed/main.py`; dependency pin: `src/embed/requirements.txt`; unit tests: `tests/test_embed.py`; workflow trigger reference: `terraform/workflows/batch-pipeline.yaml`. [Source: docs/stories/1.3.story.md#dev-notes]
- **Technical Constraints**
  - Continue using least-privilege service accounts and existing Cloud Function IAM bindings; no additional scopes beyond `cloud-platform` should be introduced. [Source: docs/architecture/security-best-practices.md#iam-least-privilege]
- **Project Structure Notes**
  - Repository already isolates Cloud Functions under `src/{function}` with matching tests; no additional structure guidance found beyond maintaining current layout. No specific unified project structure file located in architecture docs.

## Tasks / Subtasks

1. **Dependency Upgrade (AC1)**  
   - [x] Update `src/embed/requirements.txt` to `google-cloud-aiplatform>=1.44`.  
   - [x] Document the minimum SDK version in `docs/prd/6-configuration.md`.  
   - [x] Validate dependency compatibility locally (e.g., `pip install -r src/embed/requirements.txt`) before deploy packaging.

2. **Embed gRPC Client Refactor (AC2)**
   - [x] Replace REST `AuthorizedSession.post` calls with `IndexServiceClient.upsert_datapoints` for single and batch helpers.
   - [x] Ensure IndexDatapoint uses keyword arguments: datapoint_id=, feature_vector=, crowding_tag=IndexDatapoint.CrowdingTag(crowding_attribute=).
   - [x] Ensure datapoint payload preserves `crowding_tag` semantics and handles gRPC exceptions with existing retry/backoff logic.
   - [x] Confirm no unused HTTP session code paths remain.

3. **Unit Tests & Coverage (AC3)**  
   - [x] Update `tests/test_embed.py` to mock the gRPC client for single/batch success paths.  
   - [x] Add failure-path assertions ensuring gRPC exceptions surface in logs and return values.  
   - [x] Run `python3 -m unittest tests/test_embed.py -v` and capture results.

4. **Documentation & Tooling Updates (AC4)**  
   - [x] Update `docs/architecture/ai-provider-integration-vertex-ai.md` to specify the gRPC client usage.  
   - [x] Refresh `docs/prd/4-data-flows.md` with the gRPC requirement in Step 3 and note the dependency floor.  
   - [x] Amend `verify-deployment.sh` or related ops notes if additional redeploy steps are required.

5. **Operational Validation (AC5)**  
   - [ ] Redeploy the embed function via `cd terraform && terraform plan -out=tfplan && terraform apply tfplan`.  
   - [ ] Trigger the ingest scheduler (`gcloud scheduler jobs run daily-ingest-trigger-job --location=europe-west3`) and monitor the latest workflow execution for a successful embed step.  
   - [ ] Record log links or metrics demonstrating gRPC upserts succeeded with no HTTP 404 responses.

---

**Dependencies:** Stories 1.1–1.4 must remain stable; implement this upgrade before commencing Story 1.5 follow-on work such as Cluster & Link.

## Dev Agent Record

- **Agent Model Used:** gpt-5-codex
- **Implementation Date:** 2025-10-26
- **Summary:**
  - Replaced the REST fallback with a lazily initialized `IndexServiceClient` + `IndexDatapoint` workflow for both single and batch upserts, driven by the new `VECTOR_SEARCH_INDEX` environment variable.
  - Updated the embed function dependency pin to `google-cloud-aiplatform>=1.44` and kept run ID crowding tags/error handling consistent with existing retry logic.
  - Reworked unit tests to target the gRPC client path, executed `python3 -m unittest tests/test_embed.py -v`, verified dependency installation via `pip install -r src/embed/requirements.txt`, and extended `verify-deployment.sh` with workflow/log checks and redeploy reminders.
- **Tests:** `python3 -m unittest tests/test_embed.py -v`
- **File List:** `src/embed/main.py`, `src/embed/requirements.txt`, `tests/test_embed.py`, `docs/stories/1.5.story.md`, `docs/architecture/ai-provider-integration-vertex-ai.md`, `docs/prd/4-data-flows.md`, `docs/prd/6-configuration.md`, `docs/qa/gates/1.5-vertex-ai-grpc-upsert-upgrade.yml`
- **Outstanding Follow-Ups:** Execute Terraform apply + ingest scheduler trigger and capture Vector Search log evidence to close AC5.

## QA Results

### Review Date: 2025-10-26

### Reviewed By: Quinn (Test Architect)

### Code Quality & Requirements Assessment
- Story scope clearly isolates the dependency bump and transport refactor; ACs 1–4 provide actionable steps for code and documentation updates, while AC5 ensures operational verification in production-like conditions.
- Tasks/subtasks map directly to each AC, including redeploy + scheduler run, which keeps the developer workflow deterministic.

### Requirements Traceability
- Each acceptance criterion ties to a concrete task; no coverage gaps identified for dependency, code refactor, docs, or ops validation.

### Test Coverage Review
- Unit test expectations are explicit (single + batch gRPC paths, exception handling). Recommend capturing evidence in Dev Change Log once tests run, but allocation is sufficient.

### NFR & Operational Observations
- Reliability: PASS — gRPC client adoption plus workflow rerun validation mitigates prior 404 failure mode.
- Performance, Security, Maintainability: PASS — no new surface area beyond upgraded SDK; documentation keeps future maintainers aligned.

### Issues & Recommendations
- No blocking issues found; ensure developers archive workflow execution IDs when fulfilling AC5 for auditability.

### Recommended Next Status
- Story ready to move forward for implementation planning once PO/Dev review is complete.

### Gate Status

Gate: PASS → docs/qa/gates/1.5-vertex-ai-grpc-upsert-upgrade.yml
