---
epicNum: 1
storyNum: 5
title: "Migrate to Firestore Native Vector Search"
status: "Done"
---

# Story: Migrate to Firestore Native Vector Search

As a **pipeline maintainer**, I want **the embed stage to store embeddings directly in Firestore using native vector search**, so that **we eliminate Vertex AI Vector Search costs (~$100/month) and simplify the architecture**.

## Acceptance Criteria

1. **Remove Vertex AI Vector Search Dependencies**: Remove all code related to `IndexServiceClient`, Vector Search index endpoints, and REST/gRPC upsert logic from `src/embed/main.py`.

2. **Implement Firestore Native Vector Storage**: Store embeddings directly in Firestore `kb_items` collection using the native `Vector` type with vector index support.

3. **Update Schema**: Ensure `kb_items` documents include:
   - `embedding` field with 768-dimensional vector (using `firestore_v1.vector.Vector`)
   - Standard metadata fields (title, author, source, category, tags)
   - Embedding status tracking fields

4. **Update Tests**: Refactor `tests/test_embed.py` to remove Vector Search mocking and validate Firestore-only writes with vector fields.

5. **Update Documentation**: Refresh architecture docs to document the Firestore native vector search approach and cost savings (~$100/month → ~$0.10/month).

## Dev Notes

- **Architecture Context**
  - Previous approach used Vertex AI Vector Search with separate index endpoints (~$100/month baseline cost)
  - Firestore native vector search provides comparable functionality at ~$0.10/month
  - **99% cost reduction** achieved while maintaining all functionality
  - [Source: docs/architecture/ai-provider-integration-vertex-ai.md]

- **Technical Approach**
  - Use `google.cloud.firestore_v1.vector.Vector` to wrap 768-dim embedding arrays
  - Store embeddings directly in Firestore `kb_items` collection
  - Create vector index on `embedding` field for similarity search
  - Remove all Vector Search client code (IndexServiceClient, REST/gRPC upsert logic)

- **Data Models**
  - `kb_items` structure:
    - `embedding`: Vector field (768 dimensions)
    - `title`, `author`, `source`, `category`, `tags`: Metadata
    - `embedding_status`, `content_hash`: Processing tracking
  - `pipeline_items` retains `embedding_status`, `retry_count`, `manifest_run_id`

- **File Locations**
  - Embed Cloud Function: `src/embed/main.py`
  - Requirements: `src/embed/requirements.txt`
  - Tests: `tests/test_embed.py`
  - Architecture docs: `docs/architecture/ai-provider-integration-vertex-ai.md`

- **Testing Requirements**
  - Remove Vector Search client mocks
  - Test Firestore writes with Vector field type
  - Validate embedding generation still works via Vertex AI Embeddings API
  - Ensure error handling and retries work correctly

## Tasks / Subtasks

1. **Remove Vector Search Code (AC1)**
   - [x] Remove `IndexServiceClient` initialization and usage
   - [x] Remove REST/gRPC Vector Search upsert functions
   - [x] Remove Vector Search index endpoint configuration
   - [x] Clean up unused imports and environment variables

2. **Implement Firestore Vector Storage (AC2, AC3)**
   - [x] Import `google.cloud.firestore_v1.vector.Vector`
   - [x] Wrap embedding arrays with `Vector()` before Firestore write
   - [x] Update `write_to_firestore()` to handle Vector type
   - [x] Ensure proper error handling for vector operations
   - [x] Add vector index configuration notes

3. **Update Tests (AC4)**
   - [x] Remove Vector Search client mocks from `tests/test_embed.py`
   - [x] Add Vector type validation in Firestore write tests
   - [x] Ensure embedding generation tests still pass
   - [x] Run `python3 -m unittest tests/test_embed.py -v`

4. **Update Documentation (AC5)**
   - [x] Update `docs/architecture/ai-provider-integration-vertex-ai.md`
   - [x] Document cost savings (~$100/month → ~$0.10/month)
   - [x] Update `docs/architecture/cost-optimization-scaling.md`
   - [x] Note 99% cost reduction in architecture docs

5. **Deployment & Validation**
   - [x] Deploy updated embed function via Terraform
   - [x] Trigger daily ingest pipeline
   - [x] Verify embeddings stored correctly in Firestore
   - [x] Confirm vector search queries work with native Firestore

---

**Dependencies:** Stories 1.1–1.4 must be stable. This story enables significant cost savings and architectural simplification.

## Dev Agent Record

- **Implementation Date:** 2025-10-27
- **Summary:**
  - Migrated from Vertex AI Vector Search (~$100/month) to Firestore native vector search (~$0.10/month)
  - Removed all Vector Search client code (IndexServiceClient, REST/gRPC upsert logic)
  - Implemented direct Firestore storage using `firestore_v1.vector.Vector` type for 768-dim embeddings
  - Updated tests to validate Firestore-only writes with vector fields
  - Documented 99% cost reduction in architecture docs
- **Cost Impact:** $100/month → $0.10/month (99% reduction)
- **Tests:** All tests passing with Firestore vector storage
- **Files Modified:**
  - `src/embed/main.py`
  - `tests/test_embed.py`
  - `docs/architecture/ai-provider-integration-vertex-ai.md`
  - `docs/architecture/cost-optimization-scaling.md`

## QA Results

### Review Date: 2025-10-27

### Reviewed By: System Validation

### Implementation Assessment
- ✅ Successfully migrated from Vertex AI Vector Search to Firestore native vectors
- ✅ All Vector Search client code removed cleanly
- ✅ Firestore vector storage working correctly with 768-dim embeddings
- ✅ Tests updated and passing
- ✅ Documentation reflects new architecture

### Cost Validation
- ✅ **99% cost reduction achieved**: $100/month → $0.10/month
- ✅ Functionality maintained while simplifying architecture
- ✅ No operational issues reported

### Test Coverage
- ✅ Firestore vector write tests passing
- ✅ Embedding generation tests passing
- ✅ Error handling validated

### Operational Status
- ✅ Deployed to production
- ✅ Daily ingest pipeline running successfully
- ✅ Vector search queries working with Firestore native vectors

### Gate Status

**COMPLETE** - Story delivered successfully with significant cost savings and architectural improvements.
