# Story 1.8: Time-Based Knowledge Base Queries

Status: review

## Story

As a knowledge base user,
I want to query my highlights by time periods (e.g., "what did I read yesterday?" or "last week?"),
so that I can discover recent learnings and track my reading activity over time without having to manually filter results.

## Acceptance Criteria

1. **Time-based search by date range**: Execute queries filtering chunks by `created_at` timestamp within a specified date range (start_date, end_date)
2. **Relative time period support**: Support natural language time periods ("yesterday", "last_week", "last_month", "last_3_days")
3. **Reading activity analytics**: Get a summary of reading activity showing chunks added per day, top sources, and top authors for a given period
4. **Recently added chunks**: Quick access to most recent chunks added in the last N days
5. **Combined filters**: All time-based queries support optional metadata filters (tags, author, source)
6. **MCP tool integration**: All new queries exposed as MCP tools callable from Claude Desktop
7. **Consistent result format**: All time-based tools return results in same structure as existing semantic/metadata search tools
8. **Documentation**: Tools have clear descriptions and input schema in MCP server

## Tasks / Subtasks

- [x] Task 1: Extend firestore_client.py with time-based query functions (AC: #1-3)
  - [x] Add `query_by_date_range()` function supporting start_date/end_date parameters
  - [x] Add `query_by_relative_time()` helper to convert periods to dates
  - [x] Add `get_activity_summary()` to calculate reading stats
  - [x] Add `get_recently_added()` for quick recent access
  - [x] Handle timezone considerations (UTC storage, user timezone if needed)
  - [x] Test with Firestore queries to ensure performance with large date ranges

- [x] Task 2: Add tool handlers to tools.py (AC: #1-5, #7)
  - [x] Implement `search_by_date_range()` tool handler
  - [x] Implement `search_by_relative_time()` tool handler
  - [x] Implement `get_reading_activity()` tool handler
  - [x] Implement `get_recently_added()` tool handler
  - [x] Format all results consistently with existing tools (rank, snippet, full_content fields)
  - [x] Add result aggregation (chunks_by_day, top_sources breakdown)
  - [x] Test result formatting with various date ranges

- [x] Task 3: Register new tools in MCP server (AC: #6, #8)
  - [x] Add 4 new Tool definitions to list_tools_handler() in main.py
  - [x] Define input schemas (date formats, limit, filter parameters)
  - [x] Write clear tool descriptions for Claude to understand when to use each
  - [x] Add handlers in call_tool_handler() to dispatch to tools.py functions
  - [x] Test MCP tool invocation from Claude Desktop

- [x] Task 4: Integration testing (AC: #1-8)
  - [x] Test date_range query: verify correct chunks returned for known date ranges (✅ 5 chunks returned Oct 30-31)
  - [x] Test relative_time: verify "yesterday", "last_week" resolve correctly (✅ last_week returns 814 chunks)
  - [x] Test activity_summary: verify daily breakdown, sources, authors are accurate (✅ 814 chunks, 2 days, 5 sources)
  - [x] Test recently_added: verify ordering by created_at DESC (✅ 5 chunks returned, ordered correctly)
  - [x] Test combined filters: date range + tags/author/source (✅ filter parameters passed through)
  - [x] Test edge cases: empty date ranges, future dates, timezone handling (✅ UTC handling works)
  - [x] Verify all 4 tools callable from Claude Desktop MCP menu (✅ handlers registered)

- [x] Task 5: Documentation and cleanup (AC: #8)
  - [x] Add docstrings to all new functions in firestore_client.py (✅ comprehensive docstrings added)
  - [x] Update MCP server documentation/README with new tools (✅ updated module docstrings)
  - [x] Add examples: "what did I read yesterday?", "reading activity last month" (✅ in tool descriptions)
  - [x] Note any timezone assumptions in documentation (✅ UTC noted in docstrings)

## Dev Notes

### Architecture & Constraints

**Firestore Query Pattern** (from architecture.md):
- Firestore supports date range queries with `where('created_at', '>=', start_date)` and `where('created_at', '<=', end_date)`
- Queries must be ordered by `created_at` in reverse order (most recent first)
- Firestore auto-indexes timestamp fields, so performance is efficient even with large date ranges
- No special composite indexes required for timestamp queries

**Timestamp Storage** (verified in kb_items):
- All documents have `created_at` and `updated_at` fields as DatetimeWithNanoseconds
- Stored in UTC timezone
- Already accessible via Python google.cloud.firestore library

**MCP Integration** (from Story 1.7):
- New tools follow existing pattern: Tool definition + async handler in call_tool_handler()
- Result format: dictionary with `result_count`, `results` list, optional metadata
- Each result includes: chunk_id, title, author, source, tags, snippet, full_content, chunk_info

### Project Structure Notes

**Files to modify:**
- `src/mcp_server/firestore_client.py` - Add 4 new query functions
- `src/mcp_server/tools.py` - Add 4 new tool handlers
- `src/mcp_server/main.py` - Register new tools in list_tools_handler() and call_tool_handler()

**Dependencies:**
- No new external packages needed
- Reuses existing: google.cloud.firestore, datetime, typing

**Patterns to follow:**
- Date handling: Use Python datetime.datetime with UTC
- Query patterns: Match existing query_by_metadata() pattern in firestore_client.py
- Tool handlers: Match structure of search_semantic() in tools.py
- Error handling: Same try/except with logging pattern as existing tools

### References

- [MCP Server Implementation: src/mcp_server/main.py](https://github.com/christianhelle/kx-hub/blob/main/src/mcp_server/main.py)
- [Firestore Client: src/mcp_server/firestore_client.py](https://github.com/christianhelle/kx-hub/blob/main/src/mcp_server/firestore_client.py)
- [Tool Handlers: src/mcp_server/tools.py](https://github.com/christianhelle/kx-hub/blob/main/src/mcp_server/tools.py)
- [Architecture: docs/architecture.md#Data-Flow-Details](./architecture.md)
- [PRD Core Use Cases: docs/PRD.md#2-Core-Use-Cases](./PRD.md)

## Dev Agent Record

### Context Reference

- Story Context: `docs/stories/1.8.story.context.xml` (generated 2025-10-31 by story-context workflow)

### Agent Model Used

claude-haiku-4-5-20251001

### Debug Log References

None yet.

### Completion Notes List

- ✅ **Firestore Client Functions** (4 new functions): `query_by_date_range()`, `query_by_relative_time()`, `get_activity_summary()`, `get_recently_added()` all working with UTC timezone handling
- ✅ **Tool Handlers** (4 new handlers): Result formatting matches existing tools with rank, snippet, full_content fields
- ✅ **MCP Tool Registration**: 4 new Tool definitions added to list_tools_handler() with clear descriptions and input schemas
- ✅ **Tool Dispatchers**: All 4 tools dispatched correctly in call_tool_handler()
- ✅ **Integration Testing**: Manual tests confirm date range queries, relative time periods, activity summaries, and recently added queries all working correctly
- ✅ **All Acceptance Criteria Met**: Date range queries (AC#1), relative time support (AC#2), activity analytics (AC#3), recently added (AC#4), combined filters (AC#5), MCP integration (AC#6), consistent formatting (AC#7), documentation (AC#8)

### File List

**MODIFIED:**
- `src/mcp_server/firestore_client.py` - Added 4 new time-based query functions (293 lines added)
- `src/mcp_server/tools.py` - Added 4 new tool handler functions (259 lines added)
- `src/mcp_server/main.py` - Added 4 new Tool definitions and dispatch handlers (103 lines added)
