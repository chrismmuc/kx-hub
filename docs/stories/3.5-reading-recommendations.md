# Story 3.5: AI-Powered Reading Recommendations

Status: drafted

## Story

As a knowledge base user querying via Claude Desktop,
I want to receive AI-powered reading recommendations based on my recent reads and top interest clusters,
so that I can discover high-quality, relevant articles to continue learning about topics I care about without manually searching the web.

## Acceptance Criteria

1. **MCP tool functional:** `get_reading_recommendations(scope, days, limit)` returns personalized article recommendations
   - `scope`: "recent" (last N days), "clusters" (top clusters), or "both" (default)
   - `days`: Lookback period for recent reads (default: 14)
   - `limit`: Maximum recommendations (default: 10)
2. **Tavily Search API integration:** Tool queries Tavily with domain filtering and recency constraints
   - Uses `include_domains` parameter with dynamic whitelist from Firestore
   - Filters to articles published within last 30 days (`days` parameter)
   - Handles API errors gracefully with clear error messages
3. **Dynamic domain whitelist:** Configuration stored in Firestore `config/recommendation_domains`
   - `quality_domains`: List of whitelisted domains (up to 300)
   - `excluded_domains`: List of blocked domains
   - Editable via `update_recommendation_domains()` MCP tool
4. **Smart query generation:** Generates search queries from KB context
   - Extracts themes from recent reads and cluster names
   - Uses knowledge card takeaways to form "beyond what you know" queries
   - Identifies stale-but-important clusters for gap detection
5. **Quality filtering via Gemini:** Each result scored and filtered
   - Content depth assessment (3+ score required, scale 1-5)
   - Author authority signals
   - Generates "why recommended" explanation linking to user's existing content
6. **Deduplication against KB:** Recommendations don't include content already in KB
   - Embeds recommendation title+snippet
   - Checks similarity against existing chunks (threshold: 0.85)
   - Skips recommendations too similar to existing content
7. **Source diversity:** Maximum 2 recommendations per domain
8. **Performance:** Tool responds in <60 seconds (processing time acceptable for quality)
9. **Cost efficiency:** Uses Tavily free tier (~1000 queries/month) + minimal Gemini calls
   - Target: <$0.10/month additional cost

## Tasks / Subtasks

- [ ] Task 1: Set up Tavily API integration (AC: #2, #9)
  - [ ] Create Tavily API account and obtain API key
  - [ ] Store API key in Google Secret Manager (`/kx-hub/tavily/api-key`)
  - [ ] Create `src/mcp_server/tavily_client.py` for API interactions
  - [ ] Implement `search(query, include_domains, days)` method
  - [ ] Add error handling and retry logic
  - [ ] Test with sample queries

- [ ] Task 2: Implement domain whitelist configuration (AC: #3)
  - [ ] Create Firestore document `config/recommendation_domains`
  - [ ] Initial whitelist: martinfowler.com, infoq.com, thoughtworks.com, thenewstack.io, anthropic.com, openai.com, huggingface.co, hbr.org, heise.de, golem.de, arxiv.org
  - [ ] Add `get_recommendation_config()` to `firestore_client.py`
  - [ ] Add `update_recommendation_config()` to `firestore_client.py`
  - [ ] Implement `update_recommendation_domains()` MCP tool

- [ ] Task 3: Implement smart query generation (AC: #4)
  - [ ] Create `src/mcp_server/recommendation_queries.py`
  - [ ] Implement `get_recent_read_themes(days)` - extract topics from recent chunks
  - [ ] Implement `get_top_cluster_themes(limit)` - get themes from largest clusters
  - [ ] Implement `get_stale_cluster_themes()` - find clusters needing refresh
  - [ ] Implement `generate_search_queries(themes, takeaways)` - create Tavily queries
  - [ ] Use knowledge card takeaways to form "beyond" queries

- [ ] Task 4: Implement quality filtering (AC: #5, #7)
  - [ ] Create `src/mcp_server/recommendation_filter.py`
  - [ ] Implement Gemini-based depth scoring (1-5 scale)
  - [ ] Implement "why recommended" explanation generation
  - [ ] Implement source diversity cap (max 2 per domain)
  - [ ] Add recency scoring (weight recent articles higher)

- [ ] Task 5: Implement KB deduplication (AC: #6)
  - [ ] Add `check_duplicate(title, snippet)` to recommendation filter
  - [ ] Embed recommendation text using existing `embeddings.py`
  - [ ] Query Firestore with `find_nearest()` to check similarity
  - [ ] Skip recommendations with similarity > 0.85

- [ ] Task 6: Implement main MCP tool (AC: #1, #8)
  - [ ] Add `get_reading_recommendations()` to `src/mcp_server/tools.py`
  - [ ] Orchestrate: analyze KB → generate queries → search → filter → dedupe → format
  - [ ] Register tool in `src/mcp_server/main.py` list_tools handler
  - [ ] Add tool call handler in `src/mcp_server/main.py` call_tool handler
  - [ ] Format response with all required fields

- [ ] Task 7: Testing and validation (AC: #1-9)
  - [ ] Unit tests for Tavily client (mocked API)
  - [ ] Unit tests for query generation
  - [ ] Unit tests for quality filtering (mocked Gemini)
  - [ ] Unit tests for deduplication
  - [ ] Integration test: End-to-end recommendation flow
  - [ ] Manual validation with Claude Desktop
  - [ ] Verify <60s response time
  - [ ] Verify cost impact <$0.10/month

- [ ] Task 8: Documentation (AC: #1)
  - [ ] Update `docs/mcp-server-usage.md` with new tools
  - [ ] Document `get_reading_recommendations()` parameters and response format
  - [ ] Document `update_recommendation_domains()` usage
  - [ ] Add example conversations demonstrating recommendations
  - [ ] Update architecture.md with Tavily integration

## Dev Notes

### Architecture & Constraints

**External API Integration:**
- **Tavily Search API**: AI-native search optimized for LLM consumption
  - Free tier: 1000 queries/month
  - Parameters: `query`, `include_domains` (max 300), `days` (recency), `topic` ("general" or "news")
  - Returns: Structured JSON with title, url, snippet, published_date
- **API Key Storage**: Google Secret Manager at `/kx-hub/tavily/api-key`

**Processing Flow:**
```
1. Analyze KB (~2s)
   ├── Get recent reads (last N days)
   ├── Get top clusters by size
   ├── Get stale clusters needing refresh
   └── Extract known authors to boost

2. Generate Smart Queries (~1s)
   ├── Cluster theme + "beyond {existing takeaways}"
   ├── Gap queries for stale clusters
   └── 5-8 queries total

3. Tavily Search (~15-20s)
   └── ~3s per query × 5-8 queries (parallelized where possible)

4. Quality Filtering (~5-10s)
   ├── Gemini depth assessment
   ├── Dedupe against KB
   ├── Source diversity cap
   └── Generate "why recommended"

5. Return Results
   └── Top N recommendations with explanations
```

**Response Format:**
```json
{
  "generated_at": "2025-12-08T14:30:00Z",
  "processing_time_seconds": 35,
  "scope": "both",
  "days_analyzed": 14,
  "queries_used": ["platform engineering beyond Team Topologies", "..."],
  "recommendations": [
    {
      "title": "The Future of Platform Engineering",
      "url": "https://martinfowler.com/articles/...",
      "author": "Martin Fowler",
      "domain": "martinfowler.com",
      "published_date": "2025-12-01",
      "snippet": "...",
      "relevance_score": 0.92,
      "recency_score": 0.95,
      "depth_score": 4,
      "related_to": {
        "type": "cluster",
        "cluster_id": "cluster-28",
        "cluster_name": "Platform Engineering and Developer Experience"
      },
      "why_recommended": "Connects to your recent reading on internal platforms and your highlights about cognitive load reduction"
    }
  ],
  "filtered_out": {
    "duplicate_count": 3,
    "low_quality_count": 2,
    "diversity_cap_count": 1
  }
}
```

**Firestore Config Document (`config/recommendation_domains`):**
```json
{
  "quality_domains": [
    "martinfowler.com", "infoq.com", "thoughtworks.com",
    "thenewstack.io", "oreilly.com", "acm.org",
    "anthropic.com", "openai.com", "huggingface.co",
    "hbr.org", "mckinsey.com", "heise.de", "golem.de", "arxiv.org"
  ],
  "excluded_domains": ["medium.com"],
  "last_updated": "2025-12-08",
  "updated_by": "initial_setup"
}
```

### Project Structure Notes

**New Files to Create:**
- `src/mcp_server/tavily_client.py` - Tavily API wrapper
- `src/mcp_server/recommendation_queries.py` - Query generation logic
- `src/mcp_server/recommendation_filter.py` - Quality filtering and deduplication
- `tests/test_recommendations.py` - Unit tests

**Files to Modify:**
- `src/mcp_server/tools.py` - Add `get_reading_recommendations()` function
- `src/mcp_server/main.py` - Register new tools (follow pattern from Story 3.4)
- `src/mcp_server/firestore_client.py` - Add config CRUD methods
- `docs/mcp-server-usage.md` - Document new tools

**Pattern from Story 3.4:**
- Tool registration: `main.py` lines 361-382 (schema), 464-468 (handler)
- Use `firestore_client.get_firestore_client()` (NOT `get_db()`)
- Error handling: Return clear error messages for invalid inputs

### Learnings from Previous Story

**From Story 3.4 (Cluster Relationship Discovery) - Status: done**

- **MCP Tool Pattern**: Tool schema in `list_tools`, handler in `call_tool` switch
- **Bug Avoided**: Use `get_firestore_client()` not `get_db()` for Firestore access
- **Testing Pattern**: Unit tests with mocked Firestore in `tests/` folder
- **Documentation**: Update `docs/mcp-server-usage.md` with parameters, response format, use cases

[Source: stories/3.4-cluster-relationship-discovery.md#Dev-Agent-Record]

### Quality Assurance Strategies

1. **Domain Whitelist**: Only search trusted sources (configurable)
2. **Recency Filter**: Tavily `days` parameter limits to recent publications
3. **Depth Assessment**: Gemini scores content quality 1-5 (require 3+)
4. **KB Deduplication**: Embedding similarity check prevents recommending known content
5. **Source Diversity**: Max 2 per domain prevents single-source dominance
6. **Gap Detection**: Prioritize searches for stale-but-important clusters
7. **Author Boost**: Weight articles by authors user has already read

### Testing Strategy

**Unit Tests:**
- Tavily client: Mock API responses, test error handling
- Query generation: Test theme extraction, query formatting
- Quality filtering: Mock Gemini responses, test scoring logic
- Deduplication: Mock Firestore vector search, test threshold

**Integration Tests:**
- End-to-end flow with real Tavily API (use test key with low limits)
- Verify response format matches schema
- Verify processing time <60s

**Manual Validation:**
- Test in Claude Desktop: "What should I read next?"
- Verify recommendations are relevant and high-quality
- Test domain whitelist updates

### Cost Analysis

| Component | Monthly Cost |
|-----------|-------------|
| Tavily API | $0 (free tier: 1000 queries/month) |
| Gemini filtering | ~$0.05 (400 articles × $0.0001) |
| Embedding for dedupe | ~$0.02 (400 embeddings) |
| **Total** | **~$0.07/month** |

### References

- [Source: docs/epics.md#Story-3.5] - Story requirements
- [Source: docs/architecture.md#MCP-Integration] - MCP server architecture
- [Source: docs/stories/3.4-cluster-relationship-discovery.md] - Previous story patterns
- [Source: Tavily API Docs](https://docs.tavily.com/documentation/api-reference/endpoint/search) - API reference
- [Source: src/mcp_server/tools.py] - Existing MCP tool implementations

## Dev Agent Record

### Context Reference

<!-- Path(s) to story context XML will be added here by context workflow -->

### Agent Model Used

Claude Opus 4.5

### Debug Log References

### Completion Notes List

### File List
