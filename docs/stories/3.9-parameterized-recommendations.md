# Story 3.9: Parameterized Recommendations

Status: done

## Story

As a knowledge base user requesting reading recommendations,
I want to optionally filter recommendations by specific clusters or use curated "hot site" lists,
so that I can get targeted recommendations for topics I'm actively exploring or from established, high-quality sources I trust.

## Acceptance Criteria

1. **Cluster filtering:** Ability to request recommendations for specific cluster(s)
   - New optional `cluster_ids` parameter accepts list of cluster IDs
   - When provided, recommendations are scoped to those clusters only
   - Queries generated from specified cluster themes/takeaways
   - Can combine with existing `scope` parameter

2. **Hot sites mode:** Curated source lists for focused discovery
   - New optional `hot_sites` parameter: `"tech"`, `"tech_de"`, `"ai"`, `"devops"`, `"business"`, or `"all"`
   - Each category maps to a curated whitelist of established, widely-known sources
   - When specified, Tavily searches restricted to those domains
   - Can combine with cluster filtering for maximum precision

3. **Expanded default whitelist:** Enhanced quality domain list (research-based)
   - **tech** (25 sources): Software architecture, engineering blogs - martinfowler.com, thoughtworks.com, infoq.com, netflixtechblog.com, engineering.atspotify.com, uber.com/blog, slack.engineering, bytebytego.com, pragmaticengineer.com, simonwillison.net, etc.
   - **tech_de** (6 sources): German tech news - heise.de, golem.de, t3n.de, the-decoder.de, computerbase.de
   - **ai** (17 sources): AI/ML research and news - anthropic.com, openai.com, huggingface.co, deepmind.google, lilianweng.github.io, karpathy.ai, latent.space, technologyreview.com, importai.substack.com, etc.
   - **devops** (13 sources): Platform engineering, DevEx - devops.com, platformengineering.org, humanitec.com, kubernetes.io/blog, cncf.io/blog, cloud provider blogs
   - **business** (13 sources): Strategy and leadership - hbr.org, mckinsey.com, stratechery.com, a16z.com, firstround.com/review, lennysnewsletter.com, etc.
   - Exclude: Medium (quality too variable), pure academic papers

4. **Hot site categories stored in Firestore:**
   - `config/hot_sites` document with categoryâ†’domain mappings
   - MCP tool `get_hot_sites_config()` to view categories
   - MCP tool `update_hot_sites_config()` to modify categories
   - Categories can overlap (anthropic.com in both "tech" and "ai")

5. **API parameter additions to `get_reading_recommendations`:**
   - `cluster_ids: string[]` - Optional list of cluster IDs to scope recommendations
   - `hot_sites: string` - Optional category: "tech", "tech_de", "ai", "devops", "business", or "all"
   - `mode: string` - Discovery mode: "balanced" (default), "fresh", "deep", "surprise_me"
   - `include_seen: boolean` - Include previously shown recommendations (default: false)
   - `predictable: boolean` - Disable query variation for reproducible results (default: false)
   - Parameters are additive filters (cluster + hot_sites = intersection)
   - Existing parameters (`scope`, `days`, `limit`) remain unchanged

6. **Discovery modes** (preset combinations for common use cases):
   - `"balanced"` (default): Standard mix - relevance 50%, recency 25%, depth 15%, authority 10%
   - `"fresh"`: Prioritize recent content - recency weight boosted to 50%
   - `"deep"`: Prioritize in-depth content - depth weight boosted to 40%
   - `"surprise_me"`: High temperature (0.8), serendipity slots increased, wider cluster exploration

7. **Response includes filter context:**
   - `filters_applied` object in response showing active filters
   - `cluster_names` if cluster_ids provided
   - `hot_sites_category` and domain count if hot_sites used
   - `mode` showing which discovery mode was used

## Tasks / Subtasks

- [x] Task 1: Design and populate hot sites categories (AC: #3, #4)
  - [x] Implement tech category (25 domains) - architecture, engineering blogs
  - [x] Implement tech_de category (6 domains) - German tech news
  - [x] Implement ai category (17 domains) - AI/ML research and news
  - [x] Implement devops category (13 domains) - platform engineering, DevEx
  - [x] Implement business category (13 domains) - strategy, leadership
  - [x] Create Firestore document structure for `config/hot_sites`
  - [x] Update `DEFAULT_QUALITY_DOMAINS` with expanded combined list

- [x] Task 2: Implement hot sites config management (AC: #4)
  - [x] Create `get_hot_sites_config()` in firestore_client.py
  - [x] Create `update_hot_sites_config()` in firestore_client.py
  - [x] Add default hot sites document creation on first access
  - [x] Unit tests for config CRUD operations

- [x] Task 3: Add MCP tools for hot sites management (AC: #4)
  - [x] Implement `get_hot_sites_config()` tool in tools.py
  - [x] Implement `update_hot_sites_config()` tool in tools.py
  - [x] Register tools in main.py with proper schemas
  - [x] Include category listing and domain counts in response

- [x] Task 4: Extend get_reading_recommendations API (AC: #1, #5, #6)
  - [x] Add `cluster_ids` parameter to tool schema in main.py
  - [x] Add `hot_sites` parameter to tool schema in main.py
  - [x] Add `mode` parameter with enum: balanced, fresh, deep, surprise_me
  - [x] Add `include_seen` boolean parameter (default false)
  - [x] Add `predictable` boolean parameter (default false)
  - [x] Update tools.py to accept and validate new parameters
  - [x] Pass parameters through to query generation and ranking

- [x] Task 5: Implement cluster filtering logic (AC: #1)
  - [x] Modify `generate_recommendation_queries()` to accept cluster_ids
  - [x] When cluster_ids provided, fetch those clusters specifically
  - [x] Generate queries only from specified cluster themes
  - [x] Handle invalid cluster IDs gracefully (warn and skip)

- [x] Task 6: Implement hot sites filtering logic (AC: #2)
  - [x] Load hot sites config on recommendation request
  - [x] Map `hot_sites` parameter to domain list
  - [x] Pass domain restriction to Tavily client `include_domains`
  - [x] Handle "all" category (union of all hot site domains)

- [x] Task 7: Implement discovery modes (AC: #6)
  - [x] Define mode presets in recommendation_filter.py
  - [x] "balanced": Default weights (50/25/15/10), temperature 0.3
  - [x] "fresh": Recency boosted (25/50/15/10), recent tavily_days
  - [x] "deep": Depth boosted (35/15/40/10), higher min_depth_score
  - [x] "surprise_me": High temperature (0.8), more serendipity slots
  - [x] Apply mode overrides to ranking config at runtime
  - [x] Implement `include_seen` flag to bypass shown URL filtering
  - [x] Implement `predictable` flag to disable query variation

- [x] Task 8: Update response format (AC: #7)
  - [x] Add `filters_applied` object to response
  - [x] Include resolved cluster names when cluster_ids used
  - [x] Include hot_sites category and domain count when used
  - [x] Include mode used in response
  - [x] Ensure backwards compatibility (filters_applied can be empty)

- [x] Task 9: Create MCP API documentation (AC: #1-7)
  - [x] Create docs/mcp-api-guide.md with comprehensive examples
  - [x] Document all get_reading_recommendations parameters
  - [x] Provide use case examples for each mode
  - [x] Document hot_sites categories with domain counts
  - [x] Include cluster filtering examples
  - [x] Add troubleshooting section

- [x] Task 10: Testing and validation (AC: #1-7)
  - [x] Unit tests for cluster filtering
  - [x] Unit tests for hot sites filtering
  - [x] Unit tests for discovery modes
  - [x] Unit tests for include_seen and predictable flags
  - [x] Integration test: Recommendations with cluster filter
  - [x] Integration test: Recommendations with hot_sites="ai"
  - [x] Integration test: mode="surprise_me"
  - [x] Manual validation: Request with various parameter combinations

## Dev Notes

### Hot Sites Category Structure

Based on web research (Dec 2025) and alignment with kx-hub cluster interests (AI/ML, Platform Engineering, DevOps, Software Architecture, Business Strategy).

```json
{
  "tech": {
    "description": "Software architecture, platform engineering, DevOps, and general tech",
    "domains": [
      "martinfowler.com",
      "thoughtworks.com",
      "infoq.com",
      "thenewstack.io",
      "dev.to",
      "news.ycombinator.com",
      "stackoverflow.blog",
      "github.blog",
      "netflixtechblog.com",
      "engineering.atspotify.com",
      "uber.com/blog",
      "eng.lyft.com",
      "slack.engineering",
      "stripe.com/blog/engineering",
      "cloudflare.com/blog",
      "blog.discord.com",
      "devops.com",
      "platformengineering.org",
      "humanitec.com/blog",
      "arstechnica.com",
      "wired.com",
      "theverge.com",
      "simonwillison.net",
      "newsletter.pragmaticengineer.com",
      "bytebytego.com"
    ]
  },
  "tech_de": {
    "description": "German tech news and professional IT sources",
    "domains": [
      "heise.de",
      "golem.de",
      "t3n.de",
      "the-decoder.de",
      "computerbase.de",
      "heise.de/ix"
    ]
  },
  "ai": {
    "description": "AI/ML research, LLMs, agents, and AI-powered development",
    "domains": [
      "anthropic.com",
      "openai.com",
      "huggingface.co",
      "deepmind.google",
      "ai.meta.com",
      "ai.google",
      "microsoft.com/en-us/research",
      "nvidia.com/blog",
      "lilianweng.github.io",
      "karpathy.ai",
      "simonwillison.net",
      "latent.space",
      "technologyreview.com",
      "unite.ai",
      "towardsdatascience.com",
      "thesequence.substack.com",
      "importai.substack.com"
    ]
  },
  "devops": {
    "description": "DevOps, SRE, platform engineering, and developer experience",
    "domains": [
      "devops.com",
      "thenewstack.io",
      "platformengineering.org",
      "humanitec.com/blog",
      "infoq.com",
      "martinfowler.com",
      "slack.engineering",
      "netflixtechblog.com",
      "aws.amazon.com/blogs/devops",
      "devblogs.microsoft.com/devops",
      "cloud.google.com/blog",
      "kubernetes.io/blog",
      "cncf.io/blog"
    ]
  },
  "business": {
    "description": "Business strategy, tech leadership, and product management",
    "domains": [
      "hbr.org",
      "mckinsey.com",
      "bcg.com",
      "stratechery.com",
      "a16z.com",
      "sequoiacap.com",
      "firstround.com/review",
      "nfx.com",
      "lennysnewsletter.com",
      "svpg.com",
      "productboard.com/blog",
      "intercom.com/blog",
      "exponentialview.co"
    ]
  }
}
```

### Category Selection Guide

| Your Interest | Recommended `hot_sites` |
|---------------|------------------------|
| AI coding assistants, LLMs, agents | `ai` |
| Platform engineering, DevEx | `devops` or `tech` |
| Software architecture, system design | `tech` |
| Business strategy, leadership | `business` |
| German tech news | `tech_de` |
| Everything | `all` |

### Complete Parameter Reference

```
get_reading_recommendations(
  # Existing parameters
  scope="both",           # "recent", "clusters", "both"
  days=14,                # Lookback period
  limit=10,               # Max recommendations

  # Story 3.9: New parameters
  cluster_ids=["cluster-28"],  # Filter to specific clusters
  hot_sites="ai",              # Source category
  mode="balanced",             # Discovery mode
  include_seen=false,          # Include previously shown
  predictable=false            # Reproducible results
)
```

### API Examples

**1. Basic (default):**
```
get_reading_recommendations()
```

**2. Fresh AI news from trusted sources:**
```
get_reading_recommendations(hot_sites="ai", mode="fresh")
```

**3. Deep platform engineering content:**
```
get_reading_recommendations(
  cluster_ids=["cluster-28", "cluster-27"],
  hot_sites="devops",
  mode="deep"
)
```

**4. Break my filter bubble:**
```
get_reading_recommendations(mode="surprise_me", limit=5)
```

**5. German tech news:**
```
get_reading_recommendations(hot_sites="tech_de", mode="fresh")
```

**6. Reproducible results (for testing):**
```
get_reading_recommendations(
  hot_sites="tech",
  predictable=true,
  include_seen=true
)
```

**Response with filters:**
```json
{
  "generated_at": "2025-12-12T10:30:00Z",
  "processing_time_seconds": 35,
  "mode": "balanced",
  "filters_applied": {
    "cluster_ids": ["cluster-28"],
    "cluster_names": ["Platform Engineering and Developer Experience"],
    "hot_sites": "devops",
    "hot_sites_domain_count": 13,
    "include_seen": false,
    "predictable": false
  },
  "recommendations": [...]
}
```

### Discovery Mode Presets

```python
DISCOVERY_MODES = {
    "balanced": {
        "weights": {"relevance": 0.50, "recency": 0.25, "depth": 0.15, "authority": 0.10},
        "temperature": 0.3,
        "tavily_days": 180,
        "slots": {"relevance": 2, "serendipity": 1, "stale_refresh": 1, "trending": 1}
    },
    "fresh": {
        "weights": {"relevance": 0.25, "recency": 0.50, "depth": 0.15, "authority": 0.10},
        "temperature": 0.2,
        "tavily_days": 30,  # Recent content only
        "slots": {"relevance": 1, "serendipity": 1, "stale_refresh": 0, "trending": 3}
    },
    "deep": {
        "weights": {"relevance": 0.35, "recency": 0.15, "depth": 0.40, "authority": 0.10},
        "temperature": 0.2,
        "tavily_days": 365,  # Include older evergreen content
        "min_depth_score": 4,  # Require higher quality
        "slots": {"relevance": 3, "serendipity": 1, "stale_refresh": 1, "trending": 0}
    },
    "surprise_me": {
        "weights": {"relevance": 0.30, "recency": 0.25, "depth": 0.25, "authority": 0.20},
        "temperature": 0.8,  # High randomization
        "tavily_days": 180,
        "slots": {"relevance": 1, "serendipity": 3, "stale_refresh": 1, "trending": 0},
        "use_related_clusters": true  # Explore adjacent topics
    }
}
```

### Firestore Document

`config/hot_sites`:
```json
{
  "categories": {
    "tech": ["martinfowler.com", ...],
    "ai": ["anthropic.com", ...],
    "business": ["hbr.org", ...]
  },
  "last_updated": "2025-12-12",
  "updated_by": "initial_setup"
}
```

### Filter Logic

```
if cluster_ids provided:
    clusters = fetch only specified clusters
    queries = generate from those clusters
else:
    use existing scope-based logic (recent/clusters/both)

if hot_sites provided:
    domains = hot_sites_config[hot_sites]  # or union for "all"
    tavily_search(include_domains=domains)
else:
    use existing quality_domains whitelist
```

### Backwards Compatibility

- All new parameters are optional
- Existing calls without parameters work identically
- `filters_applied` in response is always present but may be empty `{}`

### Dependencies

- **Story 3.5** (Reading Recommendations): Base implementation
- **Story 3.8** (Enhanced Ranking): Ranking and scoring infrastructure
- **Story 3.4** (Cluster Relationships): Cluster data access

### Research Sources (Hot Sites Curation)

Domain lists curated from web research conducted December 2025:

**AI/ML Sources:**
- [DLabs.AI - Top 16 AI Newsletters](https://dlabs.ai/blog/top-ai-newsletters-to-follow/)
- [Unite.AI - Best ML & AI Newsletters](https://www.unite.ai/ai-newsletters/)
- [Everypixel - Top AI Blogs 2024](https://journal.everypixel.com/top-ai-blogs-to-follow-in-2024)

**DevOps/Platform Engineering:**
- [DevOpsCube - Best DevOps Blogs 2025](https://devopscube.com/list-of-devops-blogs-and-resources/)
- [LabLabs - 20+ Newsletters for DevOps, SRE, Platform Engineers](https://lablabs.io/blog/20-of-the-best-newsletters-for-devops-sre-and-platform-engineers)

**Tech/Engineering Blogs:**
- [NetMidas - 16 Must-Read Engineering Blogs](https://www.netmidas.com/post/16-must-read-engineering-blogs-to-master-system-design-and-software-architecture)
- [Feedspot - 60 Best Software Engineering Blogs 2025](https://bloggers.feedspot.com/software_engineering_blogs/)
- [Pragmatic Engineer on Martin Fowler](https://newsletter.pragmaticengineer.com/p/martin-fowler)

**German Tech Sources:**
- [t3n - Die deutschen Top 25 Tech-Medien](https://t3n.de/news/deutschen-top-25-tech-medien-netz-666374/)
- [HubSpot DE - 9 KI-Newsletter](https://blog.hubspot.de/marketing/ki-newsletter)

**Business/Strategy:**
- [Feedspot - 35 Best Business Strategy Blogs 2025](https://bloggers.feedspot.com/business_strategy_blogs/)
- [McKinsey Technology Trends Outlook 2025](https://www.mckinsey.com/capabilities/tech-and-ai/our-insights/the-top-trends-in-tech)

### References

- [Source: src/mcp_server/tools.py] - get_reading_recommendations implementation
- [Source: src/mcp_server/firestore_client.py] - Config management patterns
- [Source: src/mcp_server/main.py] - MCP tool registration
- [Source: docs/stories/3.8-enhanced-recommendation-ranking.md] - Ranking patterns

## Dev Agent Record

### Context Reference

<!-- Path(s) to story context XML will be added here by context workflow -->

### Agent Model Used

Claude Opus 4.5

### Debug Log References

### Completion Notes List

**Implementation Complete (2025-12-12)**

Story 3.9 implemented with all acceptance criteria met:

1. **Hot Sites Categories**: 5 curated categories (tech, tech_de, ai, devops, business) with ~70 total domains, stored in `DEFAULT_HOT_SITES` constant and synced to Firestore `config/hot_sites` document on first access.

2. **Discovery Modes**: 4 preset modes (balanced, fresh, deep, surprise_me) with distinct weight configurations, temperature settings, and slot allocations defined in `DISCOVERY_MODES` constant.

3. **API Parameters**: Extended `get_reading_recommendations` with:
   - `cluster_ids: string[]` - Filter to specific clusters
   - `hot_sites: string` - Source category filter
   - `mode: string` - Discovery mode preset
   - `include_seen: boolean` - Bypass shown URL filtering
   - `predictable: boolean` - Disable query variation

4. **MCP Tools**: Added `get_hot_sites_config()` and `update_hot_sites_config()` tools for runtime category management.

5. **Testing**: All 45 recommendation tests pass. Updated `test_full_flow` test to mock new dependencies.

6. **Documentation**: Updated `docs/mcp-api-guide.md` with comprehensive parameter reference and use case examples.

### File List

**Modified:**
- [src/mcp_server/firestore_client.py](src/mcp_server/firestore_client.py) - Added `DEFAULT_HOT_SITES`, `get_hot_sites_config()`, `update_hot_sites_config()`, `get_hot_sites_domains()`
- [src/mcp_server/recommendation_filter.py](src/mcp_server/recommendation_filter.py) - Added `DISCOVERY_MODES` constant and `get_mode_config()` function
- [src/mcp_server/recommendation_queries.py](src/mcp_server/recommendation_queries.py) - Added `cluster_ids` parameter and `get_clusters_by_ids()` function
- [src/mcp_server/tools.py](src/mcp_server/tools.py) - Extended `get_reading_recommendations()` with new parameters, added hot sites config tools
- [src/mcp_server/main.py](src/mcp_server/main.py) - Updated tool schemas and handlers for new parameters
- [tests/test_recommendations.py](tests/test_recommendations.py) - Updated `test_full_flow` with comprehensive mocks
- [docs/mcp-api-guide.md](docs/mcp-api-guide.md) - Added ranking_config mode details
