# Story 3.7: Save Recommendations to Readwise Reader

Status: drafted

## Story

As a knowledge base user viewing reading recommendations in Claude Desktop,
I want to save recommended articles directly to my Readwise Reader library,
so that I can seamlessly add articles to my reading queue and later have my highlights flow back into kx-hub.

## Acceptance Criteria

1. **Single article save:** MCP tool `save_to_reader(url, tags, notes)` saves article to Reader
   - URL is required
   - Tags are optional (auto-adds cluster tag + "kx-recommended")
   - Notes field for personal annotation
   - Returns: saved article metadata (title, author, estimated_read_time)
2. **Batch save from recommendations:** `save_recommendations_to_reader(indices, tags)`
   - Accepts indices from `get_reading_recommendations()` response
   - Saves multiple articles in one command
   - Returns summary of saved articles
3. **Auto-tagging:** Articles automatically tagged with context
   - Source cluster name (e.g., "platform-engineering")
   - "kx-recommended" tag for tracking
   - User-specified additional tags
4. **Readwise Reader API integration:** Uses Reader's save URL endpoint
   - `POST https://readwise.io/api/v3/save/`
   - Reuses existing Readwise API key from Secret Manager
   - Handles rate limiting gracefully
5. **Duplicate detection:** Prevents saving already-saved URLs
   - Check Reader library before saving
   - Return clear message if duplicate
   - Option to force re-save
6. **Error handling:** Clear feedback on failures
   - Invalid URL format
   - API errors with retry
   - Authentication failures
7. **Confirmation response:** Returns useful metadata
   - Article title (fetched by Reader)
   - Estimated read time
   - Tags applied
   - Reader URL for direct access

## Tasks / Subtasks

- [ ] Task 1: Research Readwise Reader API (AC: #4)
  - [ ] Review Reader API documentation for save endpoint
  - [ ] Test API with existing Readwise API key
  - [ ] Verify rate limits and quotas
  - [ ] Understand response format

- [ ] Task 2: Implement Reader API client (AC: #4, #6)
  - [ ] Create `src/mcp_server/reader_client.py`
  - [ ] Implement `save_url(url, tags, notes)` method
  - [ ] Implement `check_url_exists(url)` for duplicate detection
  - [ ] Add retry logic with exponential backoff
  - [ ] Handle authentication errors

- [ ] Task 3: Implement save_to_reader MCP tool (AC: #1, #3, #7)
  - [ ] Add `save_to_reader()` to `src/mcp_server/tools.py`
  - [ ] Implement auto-tagging logic (cluster tag + kx-recommended)
  - [ ] Format confirmation response
  - [ ] Register tool in `main.py`

- [ ] Task 4: Implement batch save tool (AC: #2)
  - [ ] Add `save_recommendations_to_reader()` to tools.py
  - [ ] Accept indices from recommendation response
  - [ ] Maintain in-memory cache of last recommendations
  - [ ] Save articles sequentially (respect rate limits)
  - [ ] Return batch summary

- [ ] Task 5: Implement duplicate detection (AC: #5)
  - [ ] Query Reader API for existing URL
  - [ ] Cache recent saves in memory to avoid redundant checks
  - [ ] Return clear duplicate message
  - [ ] Add `force` parameter to override

- [ ] Task 6: Testing (AC: #1-7)
  - [ ] Unit tests for Reader client (mocked API)
  - [ ] Unit tests for save tools
  - [ ] Integration test with real Reader API
  - [ ] Test duplicate detection
  - [ ] Test batch save flow

- [ ] Task 7: Documentation (AC: #1-7)
  - [ ] Update `docs/mcp-server-usage.md` with new tools
  - [ ] Add example conversations
  - [ ] Document tag conventions
  - [ ] Add troubleshooting section

## Dev Notes

### Readwise Reader API

**Save URL Endpoint:**
```
POST https://readwise.io/api/v3/save/
Authorization: Token {READWISE_API_KEY}
Content-Type: application/json

{
  "url": "https://example.com/article",
  "tags": ["tag1", "tag2"],
  "notes": "Optional note about this article"
}
```

**Response:**
```json
{
  "id": "reader-doc-id",
  "url": "https://example.com/article",
  "title": "Article Title",
  "author": "Author Name",
  "source": "example.com",
  "word_count": 1500,
  "created_at": "2025-12-08T10:00:00Z",
  "reading_progress": 0,
  "tags": ["tag1", "tag2", "kx-recommended"]
}
```

**Check Existing URL:**
```
GET https://readwise.io/api/v3/list/?url={encoded_url}
```

### Architecture

**MCP Tool Flow:**
```
User: "Save the first two to Reader"
    │
    ▼
Claude parses indices [0, 1]
    │
    ▼
save_recommendations_to_reader(indices=[0,1])
    │
    ├─→ Get cached recommendations
    ├─→ For each recommendation:
    │     ├─→ Check if URL exists in Reader
    │     ├─→ If new: POST to Reader API
    │     └─→ Apply auto-tags
    └─→ Return batch summary
```

**In-Memory Recommendation Cache:**
```python
# Store last recommendation response for batch operations
_last_recommendations = {
    "generated_at": "2025-12-08T14:30:00Z",
    "recommendations": [...],
    "expires_at": "2025-12-08T15:30:00Z"  # 1 hour TTL
}
```

### Project Structure Notes

**New Files:**
- `src/mcp_server/reader_client.py` - Readwise Reader API wrapper
- `tests/test_reader_integration.py` - Unit tests

**Files to Modify:**
- `src/mcp_server/tools.py` - Add save tools
- `src/mcp_server/main.py` - Register tools
- `docs/mcp-server-usage.md` - Documentation

### MCP Tool Schemas

**save_to_reader:**
```json
{
  "name": "save_to_reader",
  "description": "Save an article URL to Readwise Reader library",
  "inputSchema": {
    "type": "object",
    "properties": {
      "url": {
        "type": "string",
        "description": "Article URL to save"
      },
      "tags": {
        "type": "array",
        "items": {"type": "string"},
        "description": "Optional tags (cluster tag auto-added)"
      },
      "notes": {
        "type": "string",
        "description": "Optional note to attach"
      },
      "force": {
        "type": "boolean",
        "description": "Force save even if duplicate",
        "default": false
      }
    },
    "required": ["url"]
  }
}
```

**save_recommendations_to_reader:**
```json
{
  "name": "save_recommendations_to_reader",
  "description": "Save multiple recommendations to Readwise Reader",
  "inputSchema": {
    "type": "object",
    "properties": {
      "indices": {
        "type": "array",
        "items": {"type": "integer"},
        "description": "Indices from get_reading_recommendations response (0-based)"
      },
      "additional_tags": {
        "type": "array",
        "items": {"type": "string"},
        "description": "Additional tags to apply to all"
      }
    },
    "required": ["indices"]
  }
}
```

### Response Formats

**Single Save Response:**
```json
{
  "success": true,
  "article": {
    "title": "Platform Engineering in 2025",
    "author": "Martin Fowler",
    "url": "https://martinfowler.com/...",
    "reader_url": "https://readwise.io/reader/...",
    "word_count": 2500,
    "estimated_read_time": "10 min",
    "tags": ["platform-engineering", "kx-recommended", "user-tag"]
  }
}
```

**Batch Save Response:**
```json
{
  "success": true,
  "saved_count": 2,
  "duplicate_count": 0,
  "failed_count": 0,
  "articles": [
    {
      "title": "Platform Engineering in 2025",
      "reader_url": "https://readwise.io/reader/..."
    },
    {
      "title": "AI Agents Best Practices",
      "reader_url": "https://readwise.io/reader/..."
    }
  ]
}
```

### Virtuous Knowledge Cycle

```
┌─────────────────────────────────────────────────────────┐
│                  kx-hub Knowledge Cycle                  │
├─────────────────────────────────────────────────────────┤
│                                                          │
│   ┌──────────────┐      ┌──────────────┐                │
│   │  kx-hub KB   │◄─────│   Readwise   │                │
│   │ (highlights) │      │   (ingest)   │                │
│   └──────┬───────┘      └──────▲───────┘                │
│          │                     │                         │
│          ▼                     │                         │
│   ┌──────────────┐      ┌──────┴───────┐                │
│   │ Recommend    │─────►│   Reader     │                │
│   │ (Story 3.5)  │ save │  (read +     │                │
│   └──────────────┘      │  highlight)  │                │
│                         └──────────────┘                │
│                                                          │
│   Discovery → Save → Read → Highlight → Back to KB      │
└─────────────────────────────────────────────────────────┘
```

### Dependencies

- **Story 3.5** (Reading Recommendations): Provides recommendations to save
- **Readwise Reader API**: Uses existing API key
- **No additional cost**: Uses existing Readwise subscription

### Cost Analysis

| Component | Monthly Cost |
|-----------|-------------|
| Readwise API | $0 (existing subscription) |
| **Total** | **$0/month** |

### References

- [Source: docs/epics.md#Story-3.7] - Story requirements
- [Source: docs/stories/3.5-reading-recommendations.md] - Recommendation engine
- [Readwise Reader API](https://readwise.io/api_deets) - API documentation

## Dev Agent Record

### Context Reference

<!-- Path(s) to story context XML will be added here by context workflow -->

### Agent Model Used

Claude Opus 4.5

### Debug Log References

### Completion Notes List

### File List
