<story-context id="2.7-url-link-storage" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>7</storyId>
    <title>URL Link Storage and Backfill</title>
    <status>drafted</status>
    <generatedAt>2025-11-20</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/2.7-url-link-storage.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>knowledge base user querying via Claude Desktop</asA>
    <iWant>the system to capture and store URL links from Readwise API (book readwise_url, source_url, highlight readwise_url) and return them in MCP search results</iWant>
    <soThat>I can easily navigate back to original Readwise highlights or source articles for further exploration, annotation, or sharing</soThat>
    <tasks>
      <task id="1" ac="1">Extend Firestore schema and update architecture documentation</task>
      <task id="2" ac="2,4">Update normalize function to extract URLs from raw JSON</task>
      <task id="3" ac="3">Update embed function to store URLs in Firestore</task>
      <task id="4" ac="5">Enhance MCP server to return URLs in search results</task>
      <task id="5" ac="6">Create backfill script for existing chunks</task>
      <task id="6" ac="6,7,8">Execute backfill and validate</task>
      <task id="7" ac="5,8">Testing and validation</task>
      <task id="8" ac="8">Documentation updates</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Firestore schema extended with readwise_url (required), source_url (nullable), highlight_url (nullable)</criterion>
    <criterion id="2">Normalize function extracts all three URL fields from raw JSON</criterion>
    <criterion id="3">Embed function stores URL fields in Firestore kb_items documents</criterion>
    <criterion id="4">URL fields added to markdown frontmatter alongside existing metadata</criterion>
    <criterion id="5">All MCP search tools include URL fields in response objects</criterion>
    <criterion id="6">Backfill script populates URL fields for existing 825+ chunks in under 5 minutes</criterion>
    <criterion id="7">Zero cost increase - uses existing Readwise API data</criterion>
    <criterion id="8">Backward compatibility - no breaking changes to existing MCP tools</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture/chunk-schema.md</path>
        <title>Chunk Schema Design</title>
        <section>Field Specifications</section>
        <snippet>Defines kb_items Firestore schema. URL fields already documented: readwise_url (required), source_url (nullable), highlight_url (nullable). See lines 83-85.</snippet>
      </doc>
      <doc>
        <path>docs/prd.md</path>
        <title>PRD V3 - Personal AI Knowledge Base</title>
        <section>Data Model (Brief)</section>
        <snippet>Section 5 data model already includes URL fields in kb_items: readwise_url, source_url, highlight_url. PRD alignment confirmed.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture - Google Cloud + Vertex AI</title>
        <section>Batch Processing Pipeline</section>
        <snippet>Pipeline flow shows: Normalize/Markdown + URLs -> Embed &amp; Store + URLs -> Firestore kb_items with URLs. Architecture diagram already updated.</snippet>
      </doc>
      <doc>
        <path>docs/mcp-server-usage.md</path>
        <title>MCP Server Usage Guide</title>
        <section>URL Fields in Search Results</section>
        <snippet>Documentation already added for URL fields in responses. Documents readwise_url, source_url, highlight_url with example response JSON. Lines 357-392.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-change-proposal-2025-11-20.md</path>
        <title>Sprint Change Proposal - URL Link Storage</title>
        <section>Implementation Details</section>
        <snippet>Comprehensive change proposal approved by Chris. Contains detailed implementation plan, code patterns, and handoff instructions.</snippet>
      </doc>
      <doc>
        <path>docs/stories/2.6-mcp-enhancements.md</path>
        <title>Story 2.6 - MCP Server Enhancements</title>
        <section>Learnings from Previous Stories</section>
        <snippet>Contains patterns for MCP tool enhancement: helper functions (_format_knowledge_card, _format_cluster_info), result formatting, backward compatibility approach.</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>src/normalize/transformer.py</path>
        <kind>transformer</kind>
        <symbol>generate_frontmatter</symbol>
        <lines>8-77</lines>
        <reason>Key function to modify. Currently extracts readwise_url (line 60) but NOT source_url or highlight_url. Must add extraction of all URL fields.</reason>
      </file>
      <file>
        <path>src/normalize/transformer.py</path>
        <kind>transformer</kind>
        <symbol>json_to_markdown</symbol>
        <lines>123-155</lines>
        <reason>Entry point that calls generate_frontmatter. No changes needed here - frontmatter generation is centralized.</reason>
      </file>
      <file>
        <path>src/embed/main.py</path>
        <kind>cloud function</kind>
        <symbol>write_to_firestore</symbol>
        <lines>335-440</lines>
        <reason>Key function to modify. Currently writes chunk data to Firestore. Must add URL fields to doc_data dictionary (around lines 367-386).</reason>
      </file>
      <file>
        <path>src/embed/main.py</path>
        <kind>cloud function</kind>
        <symbol>parse_markdown</symbol>
        <lines>219-277</lines>
        <reason>Parses YAML frontmatter. Add URL field normalization similar to existing 'url' handling (lines 267-274).</reason>
      </file>
      <file>
        <path>src/mcp_server/tools.py</path>
        <kind>mcp tools</kind>
        <symbol>_format_knowledge_card</symbol>
        <lines>23-40</lines>
        <reason>Example helper function pattern. Create similar _format_urls() helper for URL field formatting.</reason>
      </file>
      <file>
        <path>src/mcp_server/tools.py</path>
        <kind>mcp tools</kind>
        <symbol>_format_cluster_info</symbol>
        <lines>43-93</lines>
        <reason>Example helper function pattern. Shows how to extract and format optional fields from chunks.</reason>
      </file>
      <file>
        <path>src/mcp_server/tools.py</path>
        <kind>mcp tools</kind>
        <symbol>search_semantic</symbol>
        <lines>96-</lines>
        <reason>First search tool to enhance. Add URL fields to result formatting (follow knowledge_card/cluster pattern).</reason>
      </file>
      <file>
        <path>src/mcp_server/firestore_client.py</path>
        <kind>firestore client</kind>
        <symbol>get_chunk_by_id</symbol>
        <lines>83-</lines>
        <reason>Fetches chunk data. URL fields should be automatically included (Firestore returns all fields). Verify URL fields present in returned dict.</reason>
      </file>
      <file>
        <path>src/mcp_server/resources.py</path>
        <kind>mcp resources</kind>
        <symbol>various handlers</symbol>
        <lines>all</lines>
        <reason>Resource handlers format chunk data for display. Add URL fields to resource responses (similar to knowledge_card handling).</reason>
      </file>
      <file>
        <path>tests/fixtures/sample-book.json</path>
        <kind>test fixture</kind>
        <symbol>sample Readwise data</symbol>
        <lines>1-70</lines>
        <reason>Contains URL fields for testing: book-level readwise_url (line 14), source_url (line 15, null), highlight-level readwise_url (lines 37, 57).</reason>
      </file>
      <file>
        <path>tests/test_normalize.py</path>
        <kind>unit tests</kind>
        <symbol>test cases</symbol>
        <lines>all</lines>
        <reason>Add tests for URL field extraction in normalize function.</reason>
      </file>
      <file>
        <path>tests/test_mcp_tools.py</path>
        <kind>unit tests</kind>
        <symbol>test cases</symbol>
        <lines>all</lines>
        <reason>Add tests for URL fields in MCP tool responses.</reason>
      </file>
      <file>
        <path>tests/test_mcp_enhancements.py</path>
        <kind>integration tests</kind>
        <symbol>test cases</symbol>
        <lines>all</lines>
        <reason>Reference for MCP enhancement test patterns. 44 test cases covering knowledge_card and cluster features.</reason>
      </file>
    </code>
    <dependencies>
      <python>
        <package name="google-cloud-firestore" version="2.x">Firestore client for reading/writing kb_items</package>
        <package name="google-cloud-storage" version="2.x">GCS client for reading raw JSON in backfill</package>
        <package name="pyyaml" version="6.x">YAML parsing for frontmatter</package>
        <package name="pytest" version="7.x">Testing framework</package>
      </python>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="docs/stories/2.6-mcp-enhancements.md">No breaking changes to existing MCP tools - all changes must be additive</constraint>
    <constraint source="docs/architecture/chunk-schema.md">readwise_url is required, source_url and highlight_url are nullable</constraint>
    <constraint source="docs/prd.md">Zero cost increase - reuse existing Readwise API data</constraint>
    <constraint source="docs/stories/2.7-url-link-storage.md">Backfill must complete in under 5 minutes for 825+ chunks</constraint>
    <constraint source="pattern">Use batch writes for Firestore (batch size: 500) to avoid rate limits</constraint>
    <constraint source="pattern">Handle null source_url gracefully - many Kindle books lack this field</constraint>
    <constraint source="coding-standards">Follow existing code patterns in src/mcp_server/tools.py for helper functions</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>generate_frontmatter</name>
      <kind>function</kind>
      <signature>def generate_frontmatter(book: Dict[str, Any]) -> str</signature>
      <path>src/normalize/transformer.py:8</path>
      <modification>Add source_url and highlight_url extraction to frontmatter_data dict</modification>
    </interface>
    <interface>
      <name>write_to_firestore</name>
      <kind>function</kind>
      <signature>def write_to_firestore(metadata, content, content_hash, run_id, embedding_status, embedding_vector=None) -> bool</signature>
      <path>src/embed/main.py:335</path>
      <modification>Add readwise_url, source_url, highlight_url to doc_data dict</modification>
    </interface>
    <interface>
      <name>parse_markdown</name>
      <kind>function</kind>
      <signature>def parse_markdown(content: str) -> Tuple[Dict[str, Any], str]</signature>
      <path>src/embed/main.py:219</path>
      <modification>Add URL field normalization (set None if missing)</modification>
    </interface>
    <interface>
      <name>_format_urls (NEW)</name>
      <kind>helper function</kind>
      <signature>def _format_urls(chunk: Dict[str, Any]) -> Dict[str, Optional[str]]</signature>
      <path>src/mcp_server/tools.py (to create)</path>
      <modification>New helper function to extract and format URL fields from chunk data</modification>
    </interface>
    <interface>
      <name>backfill_urls (NEW)</name>
      <kind>script</kind>
      <signature>def backfill_urls(dry_run: bool = False) -> Dict[str, int]</signature>
      <path>src/scripts/backfill_urls.py (to create)</path>
      <modification>New backfill script to populate URL fields for existing chunks</modification>
    </interface>
  </interfaces>

  <tests>
    <standards>
      pytest framework with unittest.mock for mocking external dependencies.
      Tests located in tests/ directory following test_*.py naming convention.
      Unit tests use mocked Firestore/GCS clients; integration tests use real data.
      Follow patterns established in test_mcp_enhancements.py (44 test cases, 4 test classes).
    </standards>
    <locations>
      <location>tests/test_normalize.py</location>
      <location>tests/test_mcp_tools.py</location>
      <location>tests/test_mcp_enhancements.py</location>
      <location>tests/test_integration_chunking.py</location>
    </locations>
    <ideas>
      <idea ac="2">test_normalize_extracts_readwise_url - Verify readwise_url extracted from book JSON</idea>
      <idea ac="2">test_normalize_extracts_source_url_when_present - Verify source_url extraction for articles</idea>
      <idea ac="2">test_normalize_handles_null_source_url - Verify null source_url handled gracefully</idea>
      <idea ac="2">test_normalize_extracts_highlight_url - Verify highlight-level readwise_url extraction</idea>
      <idea ac="3">test_embed_stores_url_fields - Verify URL fields written to Firestore doc_data</idea>
      <idea ac="3">test_embed_handles_missing_url_fields - Verify None values for missing URLs</idea>
      <idea ac="4">test_frontmatter_includes_url_fields - Verify URL fields in markdown frontmatter</idea>
      <idea ac="5">test_mcp_search_semantic_includes_urls - Verify URLs in search_semantic response</idea>
      <idea ac="5">test_mcp_search_by_metadata_includes_urls - Verify URLs in search_by_metadata response</idea>
      <idea ac="5">test_mcp_get_related_chunks_includes_urls - Verify URLs in get_related_chunks response</idea>
      <idea ac="5">test_mcp_format_urls_helper - Test _format_urls helper function</idea>
      <idea ac="5">test_mcp_format_urls_handles_nulls - Verify null URL handling in helper</idea>
      <idea ac="6">test_backfill_dry_run_no_writes - Verify dry-run mode doesn't write</idea>
      <idea ac="6">test_backfill_extracts_urls_correctly - Verify URL extraction from raw JSON</idea>
      <idea ac="6">test_backfill_batch_updates - Verify batch size of 500</idea>
      <idea ac="8">test_backward_compatibility_no_breaking_changes - Verify existing tools still work</idea>
    </ideas>
  </tests>
</story-context>
