# Story 3.6: Email Digest for Reading Recommendations

Status: drafted

## Story

As a knowledge base user,
I want to receive a weekly email digest with personalized reading recommendations,
so that I can discover relevant articles passively without actively querying Claude Desktop.

## Acceptance Criteria

1. **Scheduled delivery:** Cloud Scheduler triggers email digest on configurable schedule
   - Default: Weekly on Monday at 8:00 AM (user's timezone)
   - Options: daily, weekly, biweekly
   - Configurable via MCP tool or Firestore
2. **Email content:** HTML email contains top N recommendations from Story 3.5 engine
   - Recommendation cards with title, author, domain, snippet
   - "Why recommended" explanation for each
   - Related cluster information
   - Direct links to articles
3. **SendGrid integration:** Email delivered via SendGrid API
   - Transactional email template
   - Sender: configurable (default: noreply@kx-hub)
   - Uses SendGrid free tier (~100 emails/day)
4. **Configuration management:** Firestore `config/email_digest` document
   - `enabled`: boolean (default: false)
   - `schedule`: "daily" | "weekly" | "biweekly"
   - `day_of_week`: 0-6 (Monday=0, for weekly)
   - `hour`: 0-23 (in user's timezone)
   - `timezone`: string (e.g., "Europe/Berlin")
   - `recipient_email`: string
   - `recommendation_count`: number (default: 5)
5. **MCP tool for configuration:** `configure_email_digest(enabled, schedule, email, ...)`
   - Enable/disable digest
   - Update schedule and preferences
   - Test send (immediate delivery for testing)
6. **Unsubscribe mechanism:** One-click unsubscribe link in email footer
   - Disables digest without requiring login
   - Secure token-based unsubscribe
7. **Error handling:** Graceful failure with logging
   - Retry on SendGrid API errors (max 3 attempts)
   - Alert on repeated failures
   - Skip digest if no new recommendations
8. **Responsive design:** Email renders correctly on mobile and desktop
   - Gmail, Outlook, Apple Mail tested
   - Dark mode compatible

## Tasks / Subtasks

- [ ] Task 1: Set up SendGrid integration (AC: #3)
  - [ ] Create SendGrid account and verify sender domain
  - [ ] Obtain API key and store in Secret Manager (`/kx-hub/sendgrid/api-key`)
  - [ ] Create `functions/email_digest/sendgrid_client.py`
  - [ ] Implement `send_email(to, subject, html_content)` method
  - [ ] Add retry logic with exponential backoff
  - [ ] Test with sample email

- [ ] Task 2: Create email HTML template (AC: #2, #8)
  - [ ] Design responsive HTML template for recommendations
  - [ ] Create recommendation card component
  - [ ] Add header with kx-hub branding
  - [ ] Add unsubscribe footer
  - [ ] Test across email clients (Gmail, Outlook, Apple Mail)
  - [ ] Store template in `functions/email_digest/templates/`

- [ ] Task 3: Implement digest configuration (AC: #4)
  - [ ] Create Firestore document `config/email_digest`
  - [ ] Add `get_email_digest_config()` to firestore helpers
  - [ ] Add `update_email_digest_config()` to firestore helpers
  - [ ] Implement timezone handling
  - [ ] Validate schedule parameters

- [ ] Task 4: Implement Cloud Function for digest (AC: #1, #7)
  - [ ] Create `functions/email_digest/main.py`
  - [ ] Integrate with Story 3.5 recommendation engine
  - [ ] Load config from Firestore
  - [ ] Generate email HTML from template
  - [ ] Send via SendGrid
  - [ ] Log success/failure metrics
  - [ ] Handle "no recommendations" case gracefully

- [ ] Task 5: Set up Cloud Scheduler (AC: #1)
  - [ ] Define Terraform resource for Cloud Scheduler job
  - [ ] Configure Pub/Sub topic for trigger
  - [ ] Set initial schedule (weekly Monday 8am)
  - [ ] Add job enable/disable capability

- [ ] Task 6: Implement MCP configuration tool (AC: #5)
  - [ ] Add `configure_email_digest()` to `src/mcp_server/tools.py`
  - [ ] Register tool in `main.py`
  - [ ] Implement test send functionality
  - [ ] Validate email format
  - [ ] Return confirmation with next scheduled send

- [ ] Task 7: Implement unsubscribe mechanism (AC: #6)
  - [ ] Generate secure unsubscribe tokens
  - [ ] Create Cloud Function endpoint for unsubscribe
  - [ ] Add unsubscribe link to email template
  - [ ] Update config on unsubscribe
  - [ ] Show confirmation page

- [ ] Task 8: Testing and documentation (AC: #1-8)
  - [ ] Unit tests for SendGrid client
  - [ ] Unit tests for template rendering
  - [ ] Integration test: End-to-end digest flow
  - [ ] Test schedule configurations
  - [ ] Update `docs/mcp-server-usage.md`
  - [ ] Document email template customization

## Dev Notes

### Architecture

**Processing Flow:**
```
Cloud Scheduler (cron)
    │
    ▼
Pub/Sub Topic: email-digest-trigger
    │
    ▼
Cloud Function: email-digest
    │
    ├─→ Load config from Firestore
    ├─→ Check if enabled
    ├─→ Call recommendation engine (Story 3.5 logic)
    ├─→ Render HTML template
    ├─→ Send via SendGrid API
    └─→ Log metrics
```

**Terraform Resources:**
```hcl
# Cloud Scheduler job
resource "google_cloud_scheduler_job" "email_digest" {
  name     = "email-digest-weekly"
  schedule = "0 8 * * 1"  # Monday 8am
  ...
}

# Pub/Sub topic
resource "google_pubsub_topic" "email_digest_trigger" {
  name = "email-digest-trigger"
}
```

**Firestore Config (`config/email_digest`):**
```json
{
  "enabled": true,
  "schedule": "weekly",
  "day_of_week": 0,
  "hour": 8,
  "timezone": "Europe/Berlin",
  "recipient_email": "user@example.com",
  "recommendation_count": 5,
  "last_sent": "2025-12-08T08:00:00Z",
  "unsubscribe_token": "secure-random-token"
}
```

### Project Structure Notes

**New Files:**
- `functions/email_digest/main.py` - Cloud Function entry point
- `functions/email_digest/sendgrid_client.py` - SendGrid API wrapper
- `functions/email_digest/templates/digest.html` - Email template
- `terraform/email_digest.tf` - Infrastructure definition
- `tests/test_email_digest.py` - Unit tests

**Files to Modify:**
- `src/mcp_server/tools.py` - Add `configure_email_digest()`
- `src/mcp_server/main.py` - Register tool
- `src/mcp_server/firestore_client.py` - Add config methods
- `terraform/main.tf` - Reference email_digest module

### Dependencies

- **Story 3.5** (Reading Recommendations): Provides recommendation engine
- **SendGrid**: Free tier allows 100 emails/day
- **Secret Manager**: Store SendGrid API key

### Cost Analysis

| Component | Monthly Cost |
|-----------|-------------|
| SendGrid | $0 (free tier: 100/day) |
| Cloud Scheduler | $0 (3 free jobs) |
| Cloud Function | ~$0.01 (4 invocations/month) |
| **Total** | **~$0.01/month** |

### References

- [Source: docs/epics.md#Story-3.6] - Story requirements
- [Source: docs/architecture.md] - Pipeline architecture patterns
- [Source: docs/stories/3.5-reading-recommendations.md] - Recommendation engine
- [SendGrid API Docs](https://docs.sendgrid.com/api-reference) - Email API

## Dev Agent Record

### Context Reference

<!-- Path(s) to story context XML will be added here by context workflow -->

### Agent Model Used

Claude Opus 4.5

### Debug Log References

### Completion Notes List

### File List
